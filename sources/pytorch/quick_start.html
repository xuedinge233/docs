

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>快速开始 &mdash; 昇腾开源  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=ec38875e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../_static/statistics.js?v=ed8c2343"></script>
      <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="功能样例" href="examples.html" />
    <link rel="prev" title="安装指南" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            昇腾开源
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">开始使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ascend/quick_install.html">快速安装昇腾环境</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">原生支持的AI项目</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">PyTorch</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">安装指南</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">快速开始</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">1. 单卡训练</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deepspeed">2. 使用DeepSpeed多卡并行训练</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transforms">3. 使用Transforms进行模型微调</a></li>
<li class="toctree-l3"><a class="reference internal" href="#diffusers">4. 使用Diffusers进行模型微调</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">功能样例</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_doc.html">API 文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../llamafactory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transformers/index.html">Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whisper_cpp/index.html">Whisper.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../torchchat/index.html">Torchchat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../torchtitan/index.html">TorchTitan</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">昇腾开源</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">PyTorch</a></li>
      <li class="breadcrumb-item active">快速开始</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/sources/pytorch/quick_start.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>快速开始<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在运行下述示例之前，需要您已经安装了PyTorch-NPU环境，有关环境安装，请参考 <a class="reference internal" href="install.html"><span class="doc">安装指南</span></a></p>
</div>
<p>一般来说，要在代码中使用NPU进行训练推理，需要做以下更改：</p>
<ol class="arabic simple">
<li><p>导入torch_npu扩展包 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">torch_npu</span></code></p></li>
<li><p>将模型，以及模型输入上传到NPU上</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">device</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;npu&quot;</span><span class="p">)</span>
<span class="linenos">2</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">3</span><span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<p>下面的实例演示了如何使用NPU进行训练和推理任务：</p>
<section id="id2">
<h2>1. 单卡训练<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>以下代码使用了cifar10数据集在NPU上训练模型（截取自 <a class="reference external" href="https://pytorch.org/tutorials/beginner/blitz/cifar10_tutorial.html">PyTorch tutorials</a>），请关注高亮的内容。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Training an image classifier</span>
<span class="linenos">  3</span><span class="sd">----------------------------</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="sd">We will do the following steps in order:</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="sd">1. Load and normalize the CIFAR10 training and test datasets using</span>
<span class="linenos">  8</span><span class="sd">``torchvision``</span>
<span class="linenos">  9</span><span class="sd">1. Define a Convolutional Neural Network</span>
<span class="linenos"> 10</span><span class="sd">2. Define a loss function</span>
<span class="linenos"> 11</span><span class="sd">3. Train the network on the training data</span>
<span class="linenos"> 12</span><span class="sd">4. Test the network on the test data</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="sd">5. Load and normalize CIFAR10</span>
<span class="linenos"> 15</span><span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="sd">Using ``torchvision``, it’s extremely easy to load CIFAR10.</span>
<span class="linenos"> 18</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 19</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="hll"><span class="linenos"> 20</span><span class="c1"># 引入torch-npu包</span>
</span><span class="hll"><span class="linenos"> 21</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch_npu</span>
</span><span class="linenos"> 22</span>
<span class="hll"><span class="linenos"> 23</span><span class="c1"># 定义device</span>
</span><span class="hll"><span class="linenos"> 24</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;npu:0&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">npu</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 25</span><span class="nb">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="linenos"> 28</span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="c1">########################################################################</span>
<span class="linenos"> 31</span><span class="c1"># The output of torchvision datasets are PILImage images of range [0, 1].</span>
<span class="linenos"> 32</span><span class="c1"># We transform them to Tensors of normalized range [-1, 1].</span>
<span class="linenos"> 33</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
<span class="linenos"> 34</span>    <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos"> 35</span>    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="n">trainset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 40</span>                                        <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="linenos"> 41</span><span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<span class="linenos"> 42</span>                                        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="n">testset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 45</span>                                    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="linenos"> 46</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<span class="linenos"> 47</span>                                        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;plane&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span>
<span class="linenos"> 50</span>        <span class="s1">&#39;deer&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;frog&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;ship&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">)</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="c1">########################################################################</span>
<span class="linenos"> 53</span><span class="c1"># 2. Define a Convolutional Neural Network</span>
<span class="linenos"> 54</span><span class="c1"># ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="linenos"> 55</span><span class="c1"># Copy the neural network from the Neural Networks section before and modify it to</span>
<span class="linenos"> 56</span><span class="c1"># take 3-channel images (instead of 1-channel images as it was defined).</span>
<span class="linenos"> 57</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="linenos"> 58</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="linenos"> 62</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 63</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 64</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 65</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 66</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 67</span>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="linenos"> 68</span>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
<span class="linenos"> 69</span>        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="linenos"> 72</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="linenos"> 73</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="linenos"> 74</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># flatten all dimensions except batch</span>
<span class="linenos"> 75</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos"> 76</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos"> 77</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 78</span>        <span class="k">return</span> <span class="n">x</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="linenos"> 81</span>
<span class="hll"><span class="linenos"> 82</span><span class="c1"># 将模型加载到NPU上</span>
</span><span class="hll"><span class="linenos"> 83</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="c1">########################################################################</span>
<span class="linenos"> 86</span><span class="c1"># 3. Define a Loss function and optimizer</span>
<span class="linenos"> 87</span><span class="c1"># ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="linenos"> 88</span><span class="c1"># Let&#39;s use a Classification Cross-Entropy loss and SGD with momentum.</span>
<span class="linenos"> 89</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="linenos"> 92</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="c1">########################################################################</span>
<span class="linenos"> 95</span><span class="c1"># 4. Train the network</span>
<span class="linenos"> 96</span><span class="c1"># ^^^^^^^^^^^^^^^^^^^^</span>
<span class="linenos"> 97</span><span class="c1">#</span>
<span class="linenos"> 98</span><span class="c1"># This is when things start to get interesting.</span>
<span class="linenos"> 99</span><span class="c1"># We simply have to loop over our data iterator, and feed the inputs to the</span>
<span class="linenos">100</span><span class="c1"># network and optimize.</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># loop over the dataset multiple times</span>
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">105</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainloader</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">106</span>        <span class="c1"># get the inputs; data is a list of [inputs, labels]</span>
<span class="hll"><span class="linenos">107</span>        <span class="c1"># 将input数据发送到NPU上</span>
</span><span class="hll"><span class="linenos">108</span>        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span class="linenos">109</span>
<span class="linenos">110</span>        <span class="c1"># zero the parameter gradients</span>
<span class="linenos">111</span>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="linenos">112</span>
<span class="linenos">113</span>        <span class="c1"># forward + backward + optimize</span>
<span class="linenos">114</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="linenos">115</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="linenos">116</span>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="linenos">117</span>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="linenos">118</span>
<span class="linenos">119</span>        <span class="c1"># print statistics</span>
<span class="linenos">120</span>        <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">121</span>        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">1999</span><span class="p">:</span>    <span class="c1"># print every 2000 mini-batches</span>
<span class="linenos">122</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s1">5d</span><span class="si">}</span><span class="s1">] loss: </span><span class="si">{</span><span class="n">running_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2000</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">123</span>            <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished Training&#39;</span><span class="p">)</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="c1">########################################################################</span>
<span class="linenos">128</span><span class="c1"># 5. Test the network on the test data</span>
<span class="linenos">129</span><span class="c1"># ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="linenos">130</span><span class="c1">#</span>
<span class="linenos">131</span><span class="c1"># We have trained the network for 2 passes over the training dataset.</span>
<span class="linenos">132</span><span class="c1"># But we need to check if the network has learnt anything at all.</span>
<span class="linenos">133</span><span class="c1">#</span>
<span class="linenos">134</span><span class="c1"># We will check this by predicting the class label that the neural network</span>
<span class="linenos">135</span><span class="c1"># outputs, and checking it against the ground-truth. If the prediction is</span>
<span class="linenos">136</span><span class="c1"># correct, we add the sample to the list of correct predictions.</span>
<span class="linenos">137</span><span class="c1">#</span>
<span class="linenos">138</span><span class="c1"># Let us look at how the network performs on the whole dataset.</span>
<span class="linenos">139</span><span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">140</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">141</span><span class="c1"># since we&#39;re not training, we don&#39;t need to calculate the gradients for our outputs</span>
<span class="linenos">142</span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<span class="linenos">143</span>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span>
<span class="hll"><span class="linenos">144</span>        <span class="c1"># 将input数据发送到NPU上</span>
</span><span class="hll"><span class="linenos">145</span>        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span class="linenos">146</span>        <span class="c1"># calculate outputs by running images through the network</span>
<span class="linenos">147</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="linenos">148</span>        <span class="c1"># the class with the highest energy is what we choose as prediction</span>
<span class="linenos">149</span>        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">150</span>        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">151</span>        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy of the network on the 10000 test images: </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">total</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
<span class="linenos">154</span><span class="c1">########################################################################</span>
<span class="linenos">155</span><span class="c1"># That looks way better than chance, which is 10% accuracy (randomly picking</span>
<span class="linenos">156</span><span class="c1"># a class out of 10 classes).</span>
<span class="linenos">157</span><span class="c1"># Seems like the network learnt something.</span>
<span class="linenos">158</span><span class="c1">#</span>
<span class="linenos">159</span><span class="c1"># Hmmm, what are the classes that performed well, and the classes that did</span>
<span class="linenos">160</span><span class="c1"># not perform well:</span>
<span class="linenos">161</span>
<span class="linenos">162</span><span class="c1"># prepare to count predictions for each class</span>
<span class="linenos">163</span><span class="n">correct_pred</span> <span class="o">=</span> <span class="p">{</span><span class="n">classname</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">classname</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">}</span>
<span class="linenos">164</span><span class="n">total_pred</span> <span class="o">=</span> <span class="p">{</span><span class="n">classname</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">classname</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">}</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="c1"># again no gradients needed</span>
<span class="linenos">167</span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<span class="linenos">168</span>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span>
<span class="hll"><span class="linenos">169</span>        <span class="c1"># 将input数据发送到NPU上</span>
</span><span class="hll"><span class="linenos">170</span>        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span class="linenos">171</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="linenos">172</span>        <span class="n">_</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">173</span>        <span class="c1"># collect the correct predictions for each class</span>
<span class="linenos">174</span>        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
<span class="linenos">175</span>            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">:</span>
<span class="linenos">176</span>                <span class="n">correct_pred</span><span class="p">[</span><span class="n">classes</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">177</span>            <span class="n">total_pred</span><span class="p">[</span><span class="n">classes</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">178</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="c1"># print accuracy for each class</span>
<span class="linenos">181</span><span class="k">for</span> <span class="n">classname</span><span class="p">,</span> <span class="n">correct_count</span> <span class="ow">in</span> <span class="n">correct_pred</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">182</span>    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">correct_count</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_pred</span><span class="p">[</span><span class="n">classname</span><span class="p">]</span>
<span class="linenos">183</span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy for class: </span><span class="si">{</span><span class="n">classname</span><span class="si">:</span><span class="s1">5s</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="deepspeed">
<h2>2. 使用DeepSpeed多卡并行训练<a class="headerlink" href="#deepspeed" title="Link to this heading"></a></h2>
<p>以下代码使用了cifar10数据集，使用DeepSpeed训练模型在多张NPU卡上进行模型训练（来自 <a class="reference external" href="https://github.com/microsoft/DeepSpeedExamples/blob/master/training/cifar/cifar10_deepspeed.py">DeepSpeed Examples</a>），自DeepSpeed v0.12.6之后，代码无需任何修改，即可自动检测NPU并进行训练。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="linenos">  2</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="kn">import</span><span class="w"> </span><span class="nn">deepspeed</span>
<span class="linenos">  5</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos">  6</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="linenos">  7</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="linenos">  8</span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="linenos">  9</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="linenos"> 10</span><span class="kn">from</span><span class="w"> </span><span class="nn">deepspeed.accelerator</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_accelerator</span>
<span class="linenos"> 11</span><span class="kn">from</span><span class="w"> </span><span class="nn">deepspeed.moe.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">split_params_into_different_moe_groups_for_optimizer</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="k">def</span><span class="w"> </span><span class="nf">add_argument</span><span class="p">():</span>
<span class="linenos"> 15</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;CIFAR&quot;</span><span class="p">)</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span>    <span class="c1"># For train.</span>
<span class="linenos"> 18</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 19</span>        <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
<span class="linenos"> 20</span>        <span class="s2">&quot;--epochs&quot;</span><span class="p">,</span>
<span class="linenos"> 21</span>        <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="linenos"> 22</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 23</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of total epochs (default: 30)&quot;</span><span class="p">,</span>
<span class="linenos"> 24</span>    <span class="p">)</span>
<span class="linenos"> 25</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 26</span>        <span class="s2">&quot;--local_rank&quot;</span><span class="p">,</span>
<span class="linenos"> 27</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 28</span>        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 29</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;local rank passed from distributed launcher&quot;</span><span class="p">,</span>
<span class="linenos"> 30</span>    <span class="p">)</span>
<span class="linenos"> 31</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 32</span>        <span class="s2">&quot;--log-interval&quot;</span><span class="p">,</span>
<span class="linenos"> 33</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 34</span>        <span class="n">default</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<span class="linenos"> 35</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output logging information at a given interval&quot;</span><span class="p">,</span>
<span class="linenos"> 36</span>    <span class="p">)</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span>    <span class="c1"># For mixed precision training.</span>
<span class="linenos"> 39</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 40</span>        <span class="s2">&quot;--dtype&quot;</span><span class="p">,</span>
<span class="linenos"> 41</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">,</span>
<span class="linenos"> 42</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 43</span>        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bf16&quot;</span><span class="p">,</span> <span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="s2">&quot;fp32&quot;</span><span class="p">],</span>
<span class="linenos"> 44</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Datatype used for training&quot;</span><span class="p">,</span>
<span class="linenos"> 45</span>    <span class="p">)</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="c1"># For ZeRO Optimization.</span>
<span class="linenos"> 48</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 49</span>        <span class="s2">&quot;--stage&quot;</span><span class="p">,</span>
<span class="linenos"> 50</span>        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 51</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 52</span>        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="linenos"> 53</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Datatype used for training&quot;</span><span class="p">,</span>
<span class="linenos"> 54</span>    <span class="p">)</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span>    <span class="c1"># For MoE (Mixture of Experts).</span>
<span class="linenos"> 57</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 58</span>        <span class="s2">&quot;--moe&quot;</span><span class="p">,</span>
<span class="linenos"> 59</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 60</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 61</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use deepspeed mixture of experts (moe)&quot;</span><span class="p">,</span>
<span class="linenos"> 62</span>    <span class="p">)</span>
<span class="linenos"> 63</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 64</span>        <span class="s2">&quot;--ep-world-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(moe) expert parallel world size&quot;</span>
<span class="linenos"> 65</span>    <span class="p">)</span>
<span class="linenos"> 66</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 67</span>        <span class="s2">&quot;--num-experts&quot;</span><span class="p">,</span>
<span class="linenos"> 68</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 69</span>        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
<span class="linenos"> 70</span>        <span class="n">default</span><span class="o">=</span><span class="p">[</span>
<span class="linenos"> 71</span>            <span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 72</span>        <span class="p">],</span>
<span class="linenos"> 73</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of experts list, MoE related.&quot;</span><span class="p">,</span>
<span class="linenos"> 74</span>    <span class="p">)</span>
<span class="linenos"> 75</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 76</span>        <span class="s2">&quot;--mlp-type&quot;</span><span class="p">,</span>
<span class="linenos"> 77</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 78</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
<span class="linenos"> 79</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only applicable when num-experts &gt; 1, accepts [standard, residual]&quot;</span><span class="p">,</span>
<span class="linenos"> 80</span>    <span class="p">)</span>
<span class="linenos"> 81</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 82</span>        <span class="s2">&quot;--top-k&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(moe) gating top 1 and 2 supported&quot;</span>
<span class="linenos"> 83</span>    <span class="p">)</span>
<span class="linenos"> 84</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 85</span>        <span class="s2">&quot;--min-capacity&quot;</span><span class="p">,</span>
<span class="linenos"> 86</span>        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 87</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 88</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(moe) minimum capacity of an expert regardless of the capacity_factor&quot;</span><span class="p">,</span>
<span class="linenos"> 89</span>    <span class="p">)</span>
<span class="linenos"> 90</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 91</span>        <span class="s2">&quot;--noisy-gate-policy&quot;</span><span class="p">,</span>
<span class="linenos"> 92</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 93</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 94</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(moe) noisy gating (only supported with top-1). Valid values are None, RSample, and Jitter&quot;</span><span class="p">,</span>
<span class="linenos"> 95</span>    <span class="p">)</span>
<span class="linenos"> 96</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 97</span>        <span class="s2">&quot;--moe-param-group&quot;</span><span class="p">,</span>
<span class="linenos"> 98</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 99</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos">100</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(moe) create separate moe param groups, required when using ZeRO w. MoE&quot;</span><span class="p">,</span>
<span class="linenos">101</span>    <span class="p">)</span>
<span class="linenos">102</span>
<span class="linenos">103</span>    <span class="c1"># Include DeepSpeed configuration arguments.</span>
<span class="linenos">104</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">add_config_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="linenos">105</span>
<span class="linenos">106</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="linenos">107</span>
<span class="linenos">108</span>    <span class="k">return</span> <span class="n">args</span>
<span class="linenos">109</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="k">def</span><span class="w"> </span><span class="nf">create_moe_param_groups</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="linenos">112</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create separate parameter groups for each expert.&quot;&quot;&quot;</span>
<span class="linenos">113</span>    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;parameters&quot;</span><span class="p">}</span>
<span class="linenos">114</span>    <span class="k">return</span> <span class="n">split_params_into_different_moe_groups_for_optimizer</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="linenos">115</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="k">def</span><span class="w"> </span><span class="nf">get_ds_config</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="linenos">118</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the DeepSpeed configuration dictionary.&quot;&quot;&quot;</span>
<span class="linenos">119</span>    <span class="n">ds_config</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">120</span>        <span class="s2">&quot;train_batch_size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
<span class="linenos">121</span>        <span class="s2">&quot;steps_per_print&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
<span class="linenos">122</span>        <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">123</span>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Adam&quot;</span><span class="p">,</span>
<span class="linenos">124</span>            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">125</span>                <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
<span class="linenos">126</span>                <span class="s2">&quot;betas&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">],</span>
<span class="linenos">127</span>                <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
<span class="linenos">128</span>                <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="mf">3e-7</span><span class="p">,</span>
<span class="linenos">129</span>            <span class="p">},</span>
<span class="linenos">130</span>        <span class="p">},</span>
<span class="linenos">131</span>        <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">132</span>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
<span class="linenos">133</span>            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">134</span>                <span class="s2">&quot;warmup_min_lr&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">135</span>                <span class="s2">&quot;warmup_max_lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
<span class="linenos">136</span>                <span class="s2">&quot;warmup_num_steps&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<span class="linenos">137</span>            <span class="p">},</span>
<span class="linenos">138</span>        <span class="p">},</span>
<span class="linenos">139</span>        <span class="s2">&quot;gradient_clipping&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">140</span>        <span class="s2">&quot;prescale_gradients&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos">141</span>        <span class="s2">&quot;bf16&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bf16&quot;</span><span class="p">},</span>
<span class="linenos">142</span>        <span class="s2">&quot;fp16&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">143</span>            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;fp16&quot;</span><span class="p">,</span>
<span class="linenos">144</span>            <span class="s2">&quot;fp16_master_weights_and_grads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos">145</span>            <span class="s2">&quot;loss_scale&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">146</span>            <span class="s2">&quot;loss_scale_window&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
<span class="linenos">147</span>            <span class="s2">&quot;hysteresis&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">148</span>            <span class="s2">&quot;min_loss_scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">149</span>            <span class="s2">&quot;initial_scale_power&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
<span class="linenos">150</span>        <span class="p">},</span>
<span class="linenos">151</span>        <span class="s2">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos">152</span>        <span class="s2">&quot;zero_optimization&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">153</span>            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span>
<span class="linenos">154</span>            <span class="s2">&quot;allgather_partitions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">155</span>            <span class="s2">&quot;reduce_scatter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">156</span>            <span class="s2">&quot;allgather_bucket_size&quot;</span><span class="p">:</span> <span class="mi">50000000</span><span class="p">,</span>
<span class="linenos">157</span>            <span class="s2">&quot;reduce_bucket_size&quot;</span><span class="p">:</span> <span class="mi">50000000</span><span class="p">,</span>
<span class="linenos">158</span>            <span class="s2">&quot;overlap_comm&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">159</span>            <span class="s2">&quot;contiguous_gradients&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">160</span>            <span class="s2">&quot;cpu_offload&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos">161</span>        <span class="p">},</span>
<span class="linenos">162</span>    <span class="p">}</span>
<span class="linenos">163</span>    <span class="k">return</span> <span class="n">ds_config</span>
<span class="linenos">164</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="linenos">167</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="linenos">168</span>        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos">169</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos">170</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">171</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos">172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="linenos">173</span>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
<span class="linenos">174</span>        <span class="bp">self</span><span class="o">.</span><span class="n">moe</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">moe</span>
<span class="linenos">175</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe</span><span class="p">:</span>
<span class="linenos">176</span>            <span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
<span class="linenos">177</span>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_layer_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">178</span>            <span class="k">for</span> <span class="n">n_e</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">num_experts</span><span class="p">:</span>
<span class="linenos">179</span>                <span class="c1"># Create moe layers based on the number of experts.</span>
<span class="linenos">180</span>                <span class="bp">self</span><span class="o">.</span><span class="n">moe_layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">181</span>                    <span class="n">deepspeed</span><span class="o">.</span><span class="n">moe</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">MoE</span><span class="p">(</span>
<span class="linenos">182</span>                        <span class="n">hidden_size</span><span class="o">=</span><span class="mi">84</span><span class="p">,</span>
<span class="linenos">183</span>                        <span class="n">expert</span><span class="o">=</span><span class="n">fc3</span><span class="p">,</span>
<span class="linenos">184</span>                        <span class="n">num_experts</span><span class="o">=</span><span class="n">n_e</span><span class="p">,</span>
<span class="linenos">185</span>                        <span class="n">ep_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ep_world_size</span><span class="p">,</span>
<span class="linenos">186</span>                        <span class="n">use_residual</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">mlp_type</span> <span class="o">==</span> <span class="s2">&quot;residual&quot;</span><span class="p">,</span>
<span class="linenos">187</span>                        <span class="n">k</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span>
<span class="linenos">188</span>                        <span class="n">min_capacity</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">min_capacity</span><span class="p">,</span>
<span class="linenos">189</span>                        <span class="n">noisy_gate_policy</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">noisy_gate_policy</span><span class="p">,</span>
<span class="linenos">190</span>                    <span class="p">)</span>
<span class="linenos">191</span>                <span class="p">)</span>
<span class="linenos">192</span>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_layer_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moe_layer_list</span><span class="p">)</span>
<span class="linenos">193</span>            <span class="bp">self</span><span class="o">.</span><span class="n">fc4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="linenos">194</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">195</span>            <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="linenos">196</span>
<span class="linenos">197</span>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="linenos">198</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="linenos">199</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="linenos">200</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos">201</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos">202</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos">203</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe</span><span class="p">:</span>
<span class="linenos">204</span>            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_layer_list</span><span class="p">:</span>
<span class="linenos">205</span>                <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">206</span>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">207</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">208</span>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">209</span>        <span class="k">return</span> <span class="n">x</span>
<span class="linenos">210</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model_engine</span><span class="p">,</span> <span class="n">testset</span><span class="p">,</span> <span class="n">local_device</span><span class="p">,</span> <span class="n">target_dtype</span><span class="p">,</span> <span class="n">test_batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="linenos">213</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the network on the test data.</span>
<span class="linenos">214</span>
<span class="linenos">215</span><span class="sd">    Args:</span>
<span class="linenos">216</span><span class="sd">        model_engine (deepspeed.runtime.engine.DeepSpeedEngine): the DeepSpeed engine.</span>
<span class="linenos">217</span><span class="sd">        testset (torch.utils.data.Dataset): the test dataset.</span>
<span class="linenos">218</span><span class="sd">        local_device (str): the local device name.</span>
<span class="linenos">219</span><span class="sd">        target_dtype (torch.dtype): the target datatype for the test data.</span>
<span class="linenos">220</span><span class="sd">        test_batch_size (int): the test batch size.</span>
<span class="linenos">221</span>
<span class="linenos">222</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">223</span>    <span class="c1"># The 10 classes for CIFAR10.</span>
<span class="linenos">224</span>    <span class="n">classes</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">225</span>        <span class="s2">&quot;plane&quot;</span><span class="p">,</span>
<span class="linenos">226</span>        <span class="s2">&quot;car&quot;</span><span class="p">,</span>
<span class="linenos">227</span>        <span class="s2">&quot;bird&quot;</span><span class="p">,</span>
<span class="linenos">228</span>        <span class="s2">&quot;cat&quot;</span><span class="p">,</span>
<span class="linenos">229</span>        <span class="s2">&quot;deer&quot;</span><span class="p">,</span>
<span class="linenos">230</span>        <span class="s2">&quot;dog&quot;</span><span class="p">,</span>
<span class="linenos">231</span>        <span class="s2">&quot;frog&quot;</span><span class="p">,</span>
<span class="linenos">232</span>        <span class="s2">&quot;horse&quot;</span><span class="p">,</span>
<span class="linenos">233</span>        <span class="s2">&quot;ship&quot;</span><span class="p">,</span>
<span class="linenos">234</span>        <span class="s2">&quot;truck&quot;</span><span class="p">,</span>
<span class="linenos">235</span>    <span class="p">)</span>
<span class="linenos">236</span>
<span class="linenos">237</span>    <span class="c1"># Define the test dataloader.</span>
<span class="linenos">238</span>    <span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos">239</span>        <span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">test_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
<span class="linenos">240</span>    <span class="p">)</span>
<span class="linenos">241</span>
<span class="linenos">242</span>    <span class="c1"># For total accuracy.</span>
<span class="linenos">243</span>    <span class="n">correct</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="linenos">244</span>    <span class="c1"># For accuracy per class.</span>
<span class="linenos">245</span>    <span class="n">class_correct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">246</span>    <span class="n">class_total</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">247</span>
<span class="linenos">248</span>    <span class="c1"># Start testing.</span>
<span class="linenos">249</span>    <span class="n">model_engine</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="linenos">250</span>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<span class="linenos">251</span>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span>
<span class="linenos">252</span>            <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
<span class="linenos">253</span>            <span class="k">if</span> <span class="n">target_dtype</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">254</span>                <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
<span class="linenos">255</span>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model_engine</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_device</span><span class="p">))</span>
<span class="linenos">256</span>            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">257</span>            <span class="c1"># Count the total accuracy.</span>
<span class="linenos">258</span>            <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">259</span>            <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_device</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">260</span>
<span class="linenos">261</span>            <span class="c1"># Count the accuracy per class.</span>
<span class="linenos">262</span>            <span class="n">batch_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_device</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">263</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_batch_size</span><span class="p">):</span>
<span class="linenos">264</span>                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">265</span>                <span class="n">class_correct</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">266</span>                <span class="n">class_total</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">267</span>
<span class="linenos">268</span>    <span class="k">if</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">269</span>        <span class="nb">print</span><span class="p">(</span>
<span class="linenos">270</span>            <span class="sa">f</span><span class="s2">&quot;Accuracy of the network on the </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> test images: </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="si">:</span><span class="s2"> .0f</span><span class="si">}</span><span class="s2"> %&quot;</span>
<span class="linenos">271</span>        <span class="p">)</span>
<span class="linenos">272</span>
<span class="linenos">273</span>        <span class="c1"># For all classes, print the accuracy.</span>
<span class="linenos">274</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos">275</span>            <span class="nb">print</span><span class="p">(</span>
<span class="linenos">276</span>                <span class="sa">f</span><span class="s2">&quot;Accuracy of </span><span class="si">{</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="si">:</span><span class="s2"> &gt;5s</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">class_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="si">:</span><span class="s2"> 2.0f</span><span class="si">}</span><span class="s2"> %&quot;</span>
<span class="linenos">277</span>            <span class="p">)</span>
<span class="linenos">278</span>
<span class="linenos">279</span>
<span class="linenos">280</span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="linenos">281</span>    <span class="c1"># Initialize DeepSpeed distributed backend.</span>
<span class="linenos">282</span>    <span class="n">deepspeed</span><span class="o">.</span><span class="n">init_distributed</span><span class="p">()</span>
<span class="linenos">283</span>    <span class="n">_local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">))</span>
<span class="linenos">284</span>    <span class="n">get_accelerator</span><span class="p">()</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">_local_rank</span><span class="p">)</span>
<span class="linenos">285</span>
<span class="linenos">286</span>    <span class="c1">########################################################################</span>
<span class="linenos">287</span>    <span class="c1"># Step1. Data Preparation.</span>
<span class="linenos">288</span>    <span class="c1">#</span>
<span class="linenos">289</span>    <span class="c1"># The output of torchvision datasets are PILImage images of range [0, 1].</span>
<span class="linenos">290</span>    <span class="c1"># We transform them to Tensors of normalized range [-1, 1].</span>
<span class="linenos">291</span>    <span class="c1">#</span>
<span class="linenos">292</span>    <span class="c1"># Note:</span>
<span class="linenos">293</span>    <span class="c1">#     If running on Windows and you get a BrokenPipeError, try setting</span>
<span class="linenos">294</span>    <span class="c1">#     the num_worker of torch.utils.data.DataLoader() to 0.</span>
<span class="linenos">295</span>    <span class="c1">########################################################################</span>
<span class="linenos">296</span>    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
<span class="linenos">297</span>        <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))]</span>
<span class="linenos">298</span>    <span class="p">)</span>
<span class="linenos">299</span>
<span class="linenos">300</span>    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">301</span>        <span class="c1"># Might be downloading cifar data, let rank 0 download first.</span>
<span class="linenos">302</span>        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
<span class="linenos">303</span>
<span class="linenos">304</span>    <span class="c1"># Load or download cifar data.</span>
<span class="linenos">305</span>    <span class="n">trainset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span>
<span class="linenos">306</span>        <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
<span class="linenos">307</span>    <span class="p">)</span>
<span class="linenos">308</span>    <span class="n">testset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span>
<span class="linenos">309</span>        <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
<span class="linenos">310</span>    <span class="p">)</span>
<span class="linenos">311</span>
<span class="linenos">312</span>    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">313</span>        <span class="c1"># Cifar data is downloaded, indicate other ranks can proceed.</span>
<span class="linenos">314</span>        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
<span class="linenos">315</span>
<span class="linenos">316</span>    <span class="c1">########################################################################</span>
<span class="linenos">317</span>    <span class="c1"># Step 2. Define the network with DeepSpeed.</span>
<span class="linenos">318</span>    <span class="c1">#</span>
<span class="linenos">319</span>    <span class="c1"># First, we define a Convolution Neural Network.</span>
<span class="linenos">320</span>    <span class="c1"># Then, we define the DeepSpeed configuration dictionary and use it to</span>
<span class="linenos">321</span>    <span class="c1"># initialize the DeepSpeed engine.</span>
<span class="linenos">322</span>    <span class="c1">########################################################################</span>
<span class="linenos">323</span>    <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="linenos">324</span>
<span class="linenos">325</span>    <span class="c1"># Get list of parameters that require gradients.</span>
<span class="linenos">326</span>    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">327</span>
<span class="linenos">328</span>    <span class="c1"># If using MoE, create separate param groups for each expert.</span>
<span class="linenos">329</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">moe_param_group</span><span class="p">:</span>
<span class="linenos">330</span>        <span class="n">parameters</span> <span class="o">=</span> <span class="n">create_moe_param_groups</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="linenos">331</span>
<span class="linenos">332</span>    <span class="c1"># Initialize DeepSpeed to use the following features.</span>
<span class="linenos">333</span>    <span class="c1">#   1) Distributed model.</span>
<span class="linenos">334</span>    <span class="c1">#   2) Distributed data loader.</span>
<span class="linenos">335</span>    <span class="c1">#   3) DeepSpeed optimizer.</span>
<span class="linenos">336</span>    <span class="n">ds_config</span> <span class="o">=</span> <span class="n">get_ds_config</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="linenos">337</span>    <span class="n">model_engine</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">trainloader</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
<span class="linenos">338</span>        <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
<span class="linenos">339</span>        <span class="n">model</span><span class="o">=</span><span class="n">net</span><span class="p">,</span>
<span class="linenos">340</span>        <span class="n">model_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
<span class="linenos">341</span>        <span class="n">training_data</span><span class="o">=</span><span class="n">trainset</span><span class="p">,</span>
<span class="linenos">342</span>        <span class="n">config</span><span class="o">=</span><span class="n">ds_config</span><span class="p">,</span>
<span class="linenos">343</span>    <span class="p">)</span>
<span class="linenos">344</span>
<span class="linenos">345</span>    <span class="c1"># Get the local device name (str) and local rank (int).</span>
<span class="linenos">346</span>    <span class="n">local_device</span> <span class="o">=</span> <span class="n">get_accelerator</span><span class="p">()</span><span class="o">.</span><span class="n">device_name</span><span class="p">(</span><span class="n">model_engine</span><span class="o">.</span><span class="n">local_rank</span><span class="p">)</span>
<span class="linenos">347</span>    <span class="n">local_rank</span> <span class="o">=</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">local_rank</span>
<span class="linenos">348</span>
<span class="linenos">349</span>    <span class="c1"># For float32, target_dtype will be None so no datatype conversion needed.</span>
<span class="linenos">350</span>    <span class="n">target_dtype</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">351</span>    <span class="k">if</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">bfloat16_enabled</span><span class="p">():</span>
<span class="linenos">352</span>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span>
<span class="linenos">353</span>    <span class="k">elif</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">fp16_enabled</span><span class="p">():</span>
<span class="linenos">354</span>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">half</span>
<span class="linenos">355</span>
<span class="linenos">356</span>    <span class="c1"># Define the Classification Cross-Entropy loss function.</span>
<span class="linenos">357</span>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="linenos">358</span>
<span class="linenos">359</span>    <span class="c1">########################################################################</span>
<span class="linenos">360</span>    <span class="c1"># Step 3. Train the network.</span>
<span class="linenos">361</span>    <span class="c1">#</span>
<span class="linenos">362</span>    <span class="c1"># This is when things start to get interesting.</span>
<span class="linenos">363</span>    <span class="c1"># We simply have to loop over our data iterator, and feed the inputs to the</span>
<span class="linenos">364</span>    <span class="c1"># network and optimize. (DeepSpeed handles the distributed details for us!)</span>
<span class="linenos">365</span>    <span class="c1">########################################################################</span>
<span class="linenos">366</span>
<span class="linenos">367</span>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>  <span class="c1"># loop over the dataset multiple times</span>
<span class="linenos">368</span>        <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">369</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainloader</span><span class="p">):</span>
<span class="linenos">370</span>            <span class="c1"># Get the inputs. ``data`` is a list of [inputs, labels].</span>
<span class="linenos">371</span>            <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_device</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_device</span><span class="p">)</span>
<span class="linenos">372</span>
<span class="linenos">373</span>            <span class="c1"># Try to convert to target_dtype if needed.</span>
<span class="linenos">374</span>            <span class="k">if</span> <span class="n">target_dtype</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">375</span>                <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
<span class="linenos">376</span>
<span class="linenos">377</span>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model_engine</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="linenos">378</span>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="linenos">379</span>
<span class="linenos">380</span>            <span class="n">model_engine</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="linenos">381</span>            <span class="n">model_engine</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="linenos">382</span>
<span class="linenos">383</span>            <span class="c1"># Print statistics</span>
<span class="linenos">384</span>            <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">385</span>            <span class="k">if</span> <span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">==</span> <span class="p">(</span>
<span class="linenos">386</span>                <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">-</span> <span class="mi">1</span>
<span class="linenos">387</span>            <span class="p">):</span>  <span class="c1"># Print every log_interval mini-batches.</span>
<span class="linenos">388</span>                <span class="nb">print</span><span class="p">(</span>
<span class="linenos">389</span>                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="si">:</span><span class="s2"> d</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="si">:</span><span class="s2"> 5d</span><span class="si">}</span><span class="s2">] loss: </span><span class="si">{</span><span class="n">running_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">log_interval</span><span class="w"> </span><span class="si">:</span><span class="s2"> .3f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">390</span>                <span class="p">)</span>
<span class="linenos">391</span>                <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">392</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished Training&quot;</span><span class="p">)</span>
<span class="linenos">393</span>
<span class="linenos">394</span>    <span class="c1">########################################################################</span>
<span class="linenos">395</span>    <span class="c1"># Step 4. Test the network on the test data.</span>
<span class="linenos">396</span>    <span class="c1">########################################################################</span>
<span class="linenos">397</span>    <span class="n">test</span><span class="p">(</span><span class="n">model_engine</span><span class="p">,</span> <span class="n">testset</span><span class="p">,</span> <span class="n">local_device</span><span class="p">,</span> <span class="n">target_dtype</span><span class="p">)</span>
<span class="linenos">398</span>
<span class="linenos">399</span>
<span class="linenos">400</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">401</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">add_argument</span><span class="p">()</span>
<span class="linenos">402</span>    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transforms">
<h2>3. 使用Transforms进行模型微调<a class="headerlink" href="#transforms" title="Link to this heading"></a></h2>
<p>以下代码使用了Transforms对LLM进行微调（来自 <a class="reference external" href="https://github.com/huggingface/transformers/blob/main/examples/pytorch/language-modeling/run_clm.py">transforms examples</a>），自transforms xxx版本以及accelerator 0.21.0版本以后，代码无需任何修改，即可自动检测NPU并进行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2020 The HuggingFace Inc. team. All rights reserved.</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c1"># /// script</span>
<span class="linenos"> 17</span><span class="c1"># dependencies = [</span>
<span class="linenos"> 18</span><span class="c1">#     &quot;transformers @ git+https://github.com/huggingface/transformers.git&quot;,</span>
<span class="linenos"> 19</span><span class="c1">#     &quot;albumentations &gt;= 1.4.16&quot;,</span>
<span class="linenos"> 20</span><span class="c1">#     &quot;accelerate &gt;= 0.12.0&quot;,</span>
<span class="linenos"> 21</span><span class="c1">#     &quot;torch &gt;= 1.3&quot;,</span>
<span class="linenos"> 22</span><span class="c1">#     &quot;datasets &gt;= 2.14.0&quot;,</span>
<span class="linenos"> 23</span><span class="c1">#     &quot;sentencepiece != 0.1.92&quot;,</span>
<span class="linenos"> 24</span><span class="c1">#     &quot;protobuf&quot;,</span>
<span class="linenos"> 25</span><span class="c1">#     &quot;evaluate&quot;,</span>
<span class="linenos"> 26</span><span class="c1">#     &quot;scikit-learn&quot;,</span>
<span class="linenos"> 27</span><span class="c1"># ]</span>
<span class="linenos"> 28</span><span class="c1"># ///</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 31</span><span class="sd">Fine-tuning the library models for causal language modeling (GPT, GPT-2, CTRL, ...) on a text file or a dataset.</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">Here is the full list of checkpoints on the hub that can be fine-tuned by this script:</span>
<span class="linenos"> 34</span><span class="sd">https://huggingface.co/models?filter=text-generation</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="c1"># You can also adapt this script on your own causal language modeling task. Pointers for this are left as comments.</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 39</span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="linenos"> 40</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos"> 41</span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="linenos"> 42</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="linenos"> 43</span><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="linenos"> 44</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="kn">import</span><span class="w"> </span><span class="nn">datasets</span>
<span class="linenos"> 47</span><span class="kn">import</span><span class="w"> </span><span class="nn">evaluate</span>
<span class="linenos"> 48</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos"> 49</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">IterableDataset</span><span class="p">,</span> <span class="n">IterableDatasetDict</span><span class="p">,</span> <span class="n">load_dataset</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="kn">import</span><span class="w"> </span><span class="nn">transformers</span>
<span class="linenos"> 52</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<span class="linenos"> 53</span>    <span class="n">CONFIG_MAPPING</span><span class="p">,</span>
<span class="linenos"> 54</span>    <span class="n">MODEL_FOR_CAUSAL_LM_MAPPING</span><span class="p">,</span>
<span class="linenos"> 55</span>    <span class="n">AutoConfig</span><span class="p">,</span>
<span class="linenos"> 56</span>    <span class="n">AutoModelForCausalLM</span><span class="p">,</span>
<span class="linenos"> 57</span>    <span class="n">AutoTokenizer</span><span class="p">,</span>
<span class="linenos"> 58</span>    <span class="n">HfArgumentParser</span><span class="p">,</span>
<span class="linenos"> 59</span>    <span class="n">Trainer</span><span class="p">,</span>
<span class="linenos"> 60</span>    <span class="n">TrainingArguments</span><span class="p">,</span>
<span class="linenos"> 61</span>    <span class="n">default_data_collator</span><span class="p">,</span>
<span class="linenos"> 62</span>    <span class="n">is_torch_xla_available</span><span class="p">,</span>
<span class="linenos"> 63</span>    <span class="n">set_seed</span><span class="p">,</span>
<span class="linenos"> 64</span><span class="p">)</span>
<span class="linenos"> 65</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureLogger</span>
<span class="linenos"> 66</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.trainer_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_last_checkpoint</span>
<span class="linenos"> 67</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_min_version</span><span class="p">,</span> <span class="n">send_example_telemetry</span>
<span class="linenos"> 68</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.utils.versions</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_version</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="c1"># Will error if the minimal version of Transformers is not installed. Remove at your own risks.</span>
<span class="linenos"> 72</span><span class="n">check_min_version</span><span class="p">(</span><span class="s2">&quot;4.57.0.dev0&quot;</span><span class="p">)</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="n">require_version</span><span class="p">(</span><span class="s2">&quot;datasets&gt;=2.14.0&quot;</span><span class="p">,</span> <span class="s2">&quot;To fix: pip install -r examples/pytorch/language-modeling/requirements.txt&quot;</span><span class="p">)</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="n">MODEL_CONFIG_CLASSES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MODEL_FOR_CAUSAL_LM_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos"> 80</span><span class="n">MODEL_TYPES</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">model_type</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">MODEL_CONFIG_CLASSES</span><span class="p">)</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="nd">@dataclass</span>
<span class="linenos"> 84</span><span class="k">class</span><span class="w"> </span><span class="nc">ModelArguments</span><span class="p">:</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 86</span><span class="sd">    Arguments pertaining to which model/config/tokenizer we are going to fine-tune, or train from scratch.</span>
<span class="linenos"> 87</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>    <span class="n">model_name_or_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos"> 90</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 91</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos"> 92</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos"> 93</span>                <span class="s2">&quot;The model checkpoint for weights initialization. Don&#39;t set if you want to train a model from scratch.&quot;</span>
<span class="linenos"> 94</span>            <span class="p">)</span>
<span class="linenos"> 95</span>        <span class="p">},</span>
<span class="linenos"> 96</span>    <span class="p">)</span>
<span class="linenos"> 97</span>    <span class="n">model_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos"> 98</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 99</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;If training from scratch, pass a model type from the list: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_TYPES</span><span class="p">)},</span>
<span class="linenos">100</span>    <span class="p">)</span>
<span class="linenos">101</span>    <span class="n">config_overrides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">102</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">103</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">104</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">105</span>                <span class="s2">&quot;Override some existing default config settings when a model is trained from scratch. Example: &quot;</span>
<span class="linenos">106</span>                <span class="s2">&quot;n_embd=10,resid_pdrop=0.2,scale_attn_weights=false,summary_type=cls_index&quot;</span>
<span class="linenos">107</span>            <span class="p">)</span>
<span class="linenos">108</span>        <span class="p">},</span>
<span class="linenos">109</span>    <span class="p">)</span>
<span class="linenos">110</span>    <span class="n">config_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">111</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Pretrained config name or path if not the same as model_name&quot;</span><span class="p">}</span>
<span class="linenos">112</span>    <span class="p">)</span>
<span class="linenos">113</span>    <span class="n">tokenizer_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">114</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Pretrained tokenizer name or path if not the same as model_name&quot;</span><span class="p">}</span>
<span class="linenos">115</span>    <span class="p">)</span>
<span class="linenos">116</span>    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">117</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">118</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Where do you want to store the pretrained models downloaded from huggingface.co&quot;</span><span class="p">},</span>
<span class="linenos">119</span>    <span class="p">)</span>
<span class="linenos">120</span>    <span class="n">use_fast_tokenizer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">121</span>        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">122</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Whether to use one of the fast tokenizer (backed by the tokenizers library) or not.&quot;</span><span class="p">},</span>
<span class="linenos">123</span>    <span class="p">)</span>
<span class="linenos">124</span>    <span class="n">model_revision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">125</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span>
<span class="linenos">126</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The specific model version to use (can be a branch name, tag name or commit id).&quot;</span><span class="p">},</span>
<span class="linenos">127</span>    <span class="p">)</span>
<span class="linenos">128</span>    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">129</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">130</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">131</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">132</span>                <span class="s2">&quot;The token to use as HTTP bearer authorization for remote files. If not specified, will use the token &quot;</span>
<span class="linenos">133</span>                <span class="s2">&quot;generated when running `hf auth login` (stored in `~/.huggingface`).&quot;</span>
<span class="linenos">134</span>            <span class="p">)</span>
<span class="linenos">135</span>        <span class="p">},</span>
<span class="linenos">136</span>    <span class="p">)</span>
<span class="linenos">137</span>    <span class="n">trust_remote_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">138</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">139</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">140</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">141</span>                <span class="s2">&quot;Whether to trust the execution of code from datasets/models defined on the Hub.&quot;</span>
<span class="linenos">142</span>                <span class="s2">&quot; This option should only be set to `True` for repositories you trust and in which you have read the&quot;</span>
<span class="linenos">143</span>                <span class="s2">&quot; code, as it will execute code present on the Hub on your local machine.&quot;</span>
<span class="linenos">144</span>            <span class="p">)</span>
<span class="linenos">145</span>        <span class="p">},</span>
<span class="linenos">146</span>    <span class="p">)</span>
<span class="linenos">147</span>    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">148</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">149</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">150</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">151</span>                <span class="s2">&quot;Override the default `torch.dtype` and load the model under this dtype. If `auto` is passed, the &quot;</span>
<span class="linenos">152</span>                <span class="s2">&quot;dtype will be automatically derived from the model&#39;s weights.&quot;</span>
<span class="linenos">153</span>            <span class="p">),</span>
<span class="linenos">154</span>            <span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;bfloat16&quot;</span><span class="p">,</span> <span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span>
<span class="linenos">155</span>        <span class="p">},</span>
<span class="linenos">156</span>    <span class="p">)</span>
<span class="linenos">157</span>
<span class="linenos">158</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">159</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name_or_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">160</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">161</span>                <span class="s2">&quot;--config_overrides can&#39;t be used in combination with --config_name or --model_name_or_path&quot;</span>
<span class="linenos">162</span>            <span class="p">)</span>
<span class="linenos">163</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="nd">@dataclass</span>
<span class="linenos">166</span><span class="k">class</span><span class="w"> </span><span class="nc">DataTrainingArguments</span><span class="p">:</span>
<span class="linenos">167</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">168</span><span class="sd">    Arguments pertaining to what data we are going to input our model for training and eval.</span>
<span class="linenos">169</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">170</span>
<span class="linenos">171</span>    <span class="n">dataset_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">172</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The name of the dataset to use (via the datasets library).&quot;</span><span class="p">}</span>
<span class="linenos">173</span>    <span class="p">)</span>
<span class="linenos">174</span>    <span class="n">dataset_config_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">175</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The configuration name of the dataset to use (via the datasets library).&quot;</span><span class="p">}</span>
<span class="linenos">176</span>    <span class="p">)</span>
<span class="linenos">177</span>    <span class="n">train_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The input training data file (a text file).&quot;</span><span class="p">})</span>
<span class="linenos">178</span>    <span class="n">validation_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">179</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">180</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;An optional input evaluation data file to evaluate the perplexity on (a text file).&quot;</span><span class="p">},</span>
<span class="linenos">181</span>    <span class="p">)</span>
<span class="linenos">182</span>    <span class="n">max_train_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">183</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">184</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">185</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">186</span>                <span class="s2">&quot;For debugging purposes or quicker training, truncate the number of training examples to this &quot;</span>
<span class="linenos">187</span>                <span class="s2">&quot;value if set.&quot;</span>
<span class="linenos">188</span>            <span class="p">)</span>
<span class="linenos">189</span>        <span class="p">},</span>
<span class="linenos">190</span>    <span class="p">)</span>
<span class="linenos">191</span>    <span class="n">max_eval_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">192</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">193</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">194</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">195</span>                <span class="s2">&quot;For debugging purposes or quicker training, truncate the number of evaluation examples to this &quot;</span>
<span class="linenos">196</span>                <span class="s2">&quot;value if set.&quot;</span>
<span class="linenos">197</span>            <span class="p">)</span>
<span class="linenos">198</span>        <span class="p">},</span>
<span class="linenos">199</span>    <span class="p">)</span>
<span class="linenos">200</span>    <span class="n">streaming</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Enable streaming mode&quot;</span><span class="p">})</span>
<span class="linenos">201</span>    <span class="n">block_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">202</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">203</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">204</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span>
<span class="linenos">205</span>                <span class="s2">&quot;Optional input sequence length after tokenization. &quot;</span>
<span class="linenos">206</span>                <span class="s2">&quot;The training dataset will be truncated in block of this size for training. &quot;</span>
<span class="linenos">207</span>                <span class="s2">&quot;Default to the model max input length for single sentence inputs (take into account special tokens).&quot;</span>
<span class="linenos">208</span>            <span class="p">)</span>
<span class="linenos">209</span>        <span class="p">},</span>
<span class="linenos">210</span>    <span class="p">)</span>
<span class="linenos">211</span>    <span class="n">overwrite_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">212</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Overwrite the cached training and evaluation sets&quot;</span><span class="p">}</span>
<span class="linenos">213</span>    <span class="p">)</span>
<span class="linenos">214</span>    <span class="n">validation_split_percentage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">215</span>        <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="linenos">216</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">217</span>            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The percentage of the train set used as validation set in case there&#39;s no validation split&quot;</span>
<span class="linenos">218</span>        <span class="p">},</span>
<span class="linenos">219</span>    <span class="p">)</span>
<span class="linenos">220</span>    <span class="n">preprocessing_num_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">221</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">222</span>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of processes to use for the preprocessing.&quot;</span><span class="p">},</span>
<span class="linenos">223</span>    <span class="p">)</span>
<span class="linenos">224</span>    <span class="n">keep_linebreaks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
<span class="linenos">225</span>        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Whether to keep line breaks when using TXT files or not.&quot;</span><span class="p">}</span>
<span class="linenos">226</span>    <span class="p">)</span>
<span class="linenos">227</span>
<span class="linenos">228</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">229</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">230</span>            <span class="n">require_version</span><span class="p">(</span><span class="s2">&quot;datasets&gt;=2.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;The streaming feature requires `datasets&gt;=2.0.0`&quot;</span><span class="p">)</span>
<span class="linenos">231</span>
<span class="linenos">232</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">233</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need either a dataset name or a training/validation file.&quot;</span><span class="p">)</span>
<span class="linenos">234</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">235</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">236</span>                <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">237</span>                <span class="k">assert</span> <span class="n">extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">],</span> <span class="s2">&quot;`train_file` should be a csv, a json or a txt file.&quot;</span>
<span class="linenos">238</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">239</span>                <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">240</span>                <span class="k">assert</span> <span class="n">extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">],</span> <span class="s2">&quot;`validation_file` should be a csv, a json or a txt file.&quot;</span>
<span class="linenos">241</span>
<span class="linenos">242</span>
<span class="linenos">243</span><span class="k">def</span><span class="w"> </span><span class="nf">split_streaming_dataset</span><span class="p">(</span>
<span class="linenos">244</span>    <span class="n">full_streaming_dataset</span><span class="p">,</span>
<span class="linenos">245</span>    <span class="n">validation_percentage</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos">246</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableDatasetDict</span><span class="p">:</span>
<span class="linenos">247</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">248</span><span class="sd">    Splits a streaming dataset into</span>
<span class="linenos">249</span><span class="sd">    training and validation IterableDatasets, and supports methods like .map(), .filter(),</span>
<span class="linenos">250</span><span class="sd">    .take() and properties like .features on the resulting streams.</span>
<span class="linenos">251</span>
<span class="linenos">252</span><span class="sd">    Args:</span>
<span class="linenos">253</span><span class="sd">        full_streaming_dataset (Dataset): The name of the dataset to load (e.g., &quot;HuggingFaceFW/fineweb&quot;).</span>
<span class="linenos">254</span><span class="sd">        validation_percentage (int): The proportion of the dataset to be used for validation split.</span>
<span class="linenos">255</span>
<span class="linenos">256</span><span class="sd">    Returns:</span>
<span class="linenos">257</span><span class="sd">        IterableDatasetDict: An IterableDatasetDict containing two IterableDataset objects: (train_stream, validation_stream).</span>
<span class="linenos">258</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">259</span>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">validation_percentage</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
<span class="linenos">260</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">261</span>            <span class="sa">f</span><span class="s2">&quot;validation_percentage must be between 0 and 100 (exclusive). Passed: </span><span class="si">{</span><span class="n">validation_percentage</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">262</span>        <span class="p">)</span>
<span class="linenos">263</span>
<span class="linenos">264</span>    <span class="k">def</span><span class="w"> </span><span class="nf">split_generator</span><span class="p">(</span><span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="linenos">265</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_streaming_dataset</span><span class="p">):</span>
<span class="linenos">266</span>            <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
<span class="linenos">267</span>                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="n">validation_percentage</span><span class="p">:</span>
<span class="linenos">268</span>                    <span class="k">yield</span> <span class="n">example</span>
<span class="linenos">269</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">270</span>                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="n">validation_percentage</span><span class="p">:</span>
<span class="linenos">271</span>                    <span class="k">yield</span> <span class="n">example</span>
<span class="linenos">272</span>
<span class="linenos">273</span>    <span class="n">features</span> <span class="o">=</span> <span class="n">full_streaming_dataset</span><span class="o">.</span><span class="n">features</span>
<span class="linenos">274</span>    <span class="n">train_stream</span> <span class="o">=</span> <span class="n">IterableDataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">split_generator</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;is_train&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
<span class="linenos">275</span>    <span class="n">validation_stream</span> <span class="o">=</span> <span class="n">IterableDataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
<span class="linenos">276</span>        <span class="n">split_generator</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;is_train&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span>
<span class="linenos">277</span>    <span class="p">)</span>
<span class="linenos">278</span>
<span class="linenos">279</span>    <span class="k">return</span> <span class="n">IterableDatasetDict</span><span class="p">({</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_stream</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="n">validation_stream</span><span class="p">})</span>
<span class="linenos">280</span>
<span class="linenos">281</span>
<span class="linenos">282</span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="linenos">283</span>    <span class="c1"># See all possible arguments in src/transformers/training_args.py</span>
<span class="linenos">284</span>    <span class="c1"># or by passing the --help flag to this script.</span>
<span class="linenos">285</span>    <span class="c1"># We now keep distinct sets of args, for a cleaner separation of concerns.</span>
<span class="linenos">286</span>
<span class="linenos">287</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">HfArgumentParser</span><span class="p">((</span><span class="n">ModelArguments</span><span class="p">,</span> <span class="n">DataTrainingArguments</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">))</span>
<span class="linenos">288</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
<span class="linenos">289</span>        <span class="c1"># If we pass only one argument to the script and it&#39;s the path to a json file,</span>
<span class="linenos">290</span>        <span class="c1"># let&#39;s parse it to get our arguments.</span>
<span class="linenos">291</span>        <span class="n">model_args</span><span class="p">,</span> <span class="n">data_args</span><span class="p">,</span> <span class="n">training_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_json_file</span><span class="p">(</span><span class="n">json_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="linenos">292</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">293</span>        <span class="n">model_args</span><span class="p">,</span> <span class="n">data_args</span><span class="p">,</span> <span class="n">training_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args_into_dataclasses</span><span class="p">()</span>
<span class="linenos">294</span>
<span class="linenos">295</span>    <span class="c1"># Sending telemetry. Tracking the example usage helps us better allocate resources to maintain them. The</span>
<span class="linenos">296</span>    <span class="c1"># information sent is the one passed as arguments along with your Python/PyTorch versions.</span>
<span class="linenos">297</span>    <span class="n">send_example_telemetry</span><span class="p">(</span><span class="s2">&quot;run_clm&quot;</span><span class="p">,</span> <span class="n">model_args</span><span class="p">,</span> <span class="n">data_args</span><span class="p">)</span>
<span class="linenos">298</span>
<span class="linenos">299</span>    <span class="c1"># Setup logging</span>
<span class="linenos">300</span>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
<span class="linenos">301</span>        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos">302</span>        <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %H:%M:%S&quot;</span><span class="p">,</span>
<span class="linenos">303</span>        <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)],</span>
<span class="linenos">304</span>    <span class="p">)</span>
<span class="linenos">305</span>
<span class="linenos">306</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">should_log</span><span class="p">:</span>
<span class="linenos">307</span>        <span class="c1"># The default of training_args.log_level is passive, so we set log level at info here to have that default.</span>
<span class="linenos">308</span>        <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_info</span><span class="p">()</span>
<span class="linenos">309</span>
<span class="linenos">310</span>    <span class="n">log_level</span> <span class="o">=</span> <span class="n">training_args</span><span class="o">.</span><span class="n">get_process_log_level</span><span class="p">()</span>
<span class="linenos">311</span>    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
<span class="linenos">312</span>    <span class="n">datasets</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
<span class="linenos">313</span>    <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
<span class="linenos">314</span>    <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">enable_default_handler</span><span class="p">()</span>
<span class="linenos">315</span>    <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">enable_explicit_format</span><span class="p">()</span>
<span class="linenos">316</span>
<span class="linenos">317</span>    <span class="c1"># Log on each process the small summary:</span>
<span class="linenos">318</span>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">319</span>        <span class="sa">f</span><span class="s2">&quot;Process rank: </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">local_rank</span><span class="si">}</span><span class="s2">, device: </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">, n_gpu: </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">n_gpu</span><span class="si">}</span><span class="s2">, &quot;</span>
<span class="linenos">320</span>        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;distributed training: </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">parallel_mode</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;distributed&#39;</span><span class="si">}</span><span class="s2">, 16-bits training: </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">fp16</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">321</span>    <span class="p">)</span>
<span class="linenos">322</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training/evaluation parameters </span><span class="si">{</span><span class="n">training_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">323</span>
<span class="linenos">324</span>    <span class="c1"># Detecting last checkpoint.</span>
<span class="linenos">325</span>    <span class="n">last_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">326</span>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">training_args</span><span class="o">.</span><span class="n">overwrite_output_dir</span><span class="p">:</span>
<span class="linenos">327</span>        <span class="n">last_checkpoint</span> <span class="o">=</span> <span class="n">get_last_checkpoint</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="linenos">328</span>        <span class="k">if</span> <span class="n">last_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">329</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">330</span>                <span class="sa">f</span><span class="s2">&quot;Output directory (</span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">) already exists and is not empty. &quot;</span>
<span class="linenos">331</span>                <span class="s2">&quot;Use --overwrite_output_dir to overcome.&quot;</span>
<span class="linenos">332</span>            <span class="p">)</span>
<span class="linenos">333</span>        <span class="k">elif</span> <span class="n">last_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">training_args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">334</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="linenos">335</span>                <span class="sa">f</span><span class="s2">&quot;Checkpoint detected, resuming training at </span><span class="si">{</span><span class="n">last_checkpoint</span><span class="si">}</span><span class="s2">. To avoid this behavior, change &quot;</span>
<span class="linenos">336</span>                <span class="s2">&quot;the `--output_dir` or add `--overwrite_output_dir` to train from scratch.&quot;</span>
<span class="linenos">337</span>            <span class="p">)</span>
<span class="linenos">338</span>
<span class="linenos">339</span>    <span class="c1"># Set seed before initializing model.</span>
<span class="linenos">340</span>    <span class="n">set_seed</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos">341</span>
<span class="linenos">342</span>    <span class="c1"># Get the datasets: you can either provide your own CSV/JSON/TXT training and evaluation files (see below)</span>
<span class="linenos">343</span>    <span class="c1"># or just provide the name of one of the public datasets available on the hub at https://huggingface.co/datasets/</span>
<span class="linenos">344</span>    <span class="c1"># (the dataset will be downloaded automatically from the datasets Hub).</span>
<span class="linenos">345</span>    <span class="c1">#</span>
<span class="linenos">346</span>    <span class="c1"># For CSV/JSON files, this script will use the column called &#39;text&#39; or the first column if no column called</span>
<span class="linenos">347</span>    <span class="c1"># &#39;text&#39; is found. You can easily tweak this behavior (see below).</span>
<span class="linenos">348</span>    <span class="c1">#</span>
<span class="linenos">349</span>    <span class="c1"># In distributed training, the load_dataset function guarantee that only one local process can concurrently</span>
<span class="linenos">350</span>    <span class="c1"># download the dataset.</span>
<span class="linenos">351</span>    <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">352</span>        <span class="c1"># Downloading and loading a dataset from the hub.</span>
<span class="linenos">353</span>        <span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">354</span>            <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
<span class="linenos">355</span>            <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="p">,</span>
<span class="linenos">356</span>            <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">357</span>            <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">358</span>            <span class="n">streaming</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">,</span>
<span class="linenos">359</span>            <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">360</span>        <span class="p">)</span>
<span class="linenos">361</span>        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_datasets</span><span class="p">:</span>
<span class="linenos">362</span>            <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">363</span>                <span class="n">dataset_stream</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">364</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
<span class="linenos">365</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="p">,</span>
<span class="linenos">366</span>                    <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
<span class="linenos">367</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">368</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">369</span>                    <span class="n">streaming</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">,</span>
<span class="linenos">370</span>                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">371</span>                <span class="p">)</span>
<span class="linenos">372</span>                <span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">split_streaming_dataset</span><span class="p">(</span><span class="n">dataset_stream</span><span class="p">,</span> <span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="p">)</span>
<span class="linenos">373</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">374</span>                <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">375</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
<span class="linenos">376</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="p">,</span>
<span class="linenos">377</span>                    <span class="n">split</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;train[:</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="si">}</span><span class="s2">%]&quot;</span><span class="p">,</span>
<span class="linenos">378</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">379</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">380</span>                    <span class="n">streaming</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">,</span>
<span class="linenos">381</span>                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">382</span>                <span class="p">)</span>
<span class="linenos">383</span>                <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">384</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
<span class="linenos">385</span>                    <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="p">,</span>
<span class="linenos">386</span>                    <span class="n">split</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;train[</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="si">}</span><span class="s2">%:]&quot;</span><span class="p">,</span>
<span class="linenos">387</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">388</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">389</span>                    <span class="n">streaming</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">,</span>
<span class="linenos">390</span>                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">391</span>                <span class="p">)</span>
<span class="linenos">392</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">393</span>        <span class="n">data_files</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">394</span>        <span class="n">dataset_args</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">395</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">train_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">396</span>            <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">train_file</span>
<span class="linenos">397</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">validation_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">398</span>            <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">validation_file</span>
<span class="linenos">399</span>        <span class="n">extension</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">400</span>            <span class="n">data_args</span><span class="o">.</span><span class="n">train_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">401</span>            <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">train_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos">402</span>            <span class="k">else</span> <span class="n">data_args</span><span class="o">.</span><span class="n">validation_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">403</span>        <span class="p">)</span>
<span class="linenos">404</span>        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
<span class="linenos">405</span>            <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
<span class="linenos">406</span>            <span class="n">dataset_args</span><span class="p">[</span><span class="s2">&quot;keep_linebreaks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">keep_linebreaks</span>
<span class="linenos">407</span>        <span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">408</span>            <span class="n">extension</span><span class="p">,</span>
<span class="linenos">409</span>            <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
<span class="linenos">410</span>            <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">411</span>            <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">412</span>            <span class="o">**</span><span class="n">dataset_args</span><span class="p">,</span>
<span class="linenos">413</span>        <span class="p">)</span>
<span class="linenos">414</span>        <span class="c1"># If no validation data is there, validation_split_percentage will be used to divide the dataset.</span>
<span class="linenos">415</span>        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_datasets</span><span class="p">:</span>
<span class="linenos">416</span>            <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">417</span>                <span class="n">dataset_stream</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">418</span>                    <span class="n">extension</span><span class="p">,</span>
<span class="linenos">419</span>                    <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
<span class="linenos">420</span>                    <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
<span class="linenos">421</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">422</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">423</span>                    <span class="o">**</span><span class="n">dataset_args</span><span class="p">,</span>
<span class="linenos">424</span>                <span class="p">)</span>
<span class="linenos">425</span>                <span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">split_streaming_dataset</span><span class="p">(</span><span class="n">dataset_stream</span><span class="p">,</span> <span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="p">)</span>
<span class="linenos">426</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">427</span>                <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">428</span>                    <span class="n">extension</span><span class="p">,</span>
<span class="linenos">429</span>                    <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
<span class="linenos">430</span>                    <span class="n">split</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;train[:</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="si">}</span><span class="s2">%]&quot;</span><span class="p">,</span>
<span class="linenos">431</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">432</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">433</span>                    <span class="o">**</span><span class="n">dataset_args</span><span class="p">,</span>
<span class="linenos">434</span>                <span class="p">)</span>
<span class="linenos">435</span>
<span class="linenos">436</span>                <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos">437</span>                    <span class="n">extension</span><span class="p">,</span>
<span class="linenos">438</span>                    <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
<span class="linenos">439</span>                    <span class="n">split</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;train[</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">validation_split_percentage</span><span class="si">}</span><span class="s2">%:]&quot;</span><span class="p">,</span>
<span class="linenos">440</span>                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">441</span>                    <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">442</span>                    <span class="o">**</span><span class="n">dataset_args</span><span class="p">,</span>
<span class="linenos">443</span>                <span class="p">)</span>
<span class="linenos">444</span>
<span class="linenos">445</span>    <span class="c1"># See more about loading any type of standard or custom dataset (from files, python dict, pandas DataFrame, etc) at</span>
<span class="linenos">446</span>    <span class="c1"># https://huggingface.co/docs/datasets/loading_datasets.</span>
<span class="linenos">447</span>
<span class="linenos">448</span>    <span class="c1"># Load pretrained model and tokenizer</span>
<span class="linenos">449</span>    <span class="c1">#</span>
<span class="linenos">450</span>    <span class="c1"># Distributed training:</span>
<span class="linenos">451</span>    <span class="c1"># The .from_pretrained methods guarantee that only one local process can concurrently</span>
<span class="linenos">452</span>    <span class="c1"># download model &amp; vocab.</span>
<span class="linenos">453</span>
<span class="linenos">454</span>    <span class="n">config_kwargs</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">455</span>        <span class="s2">&quot;cache_dir&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">456</span>        <span class="s2">&quot;revision&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_revision</span><span class="p">,</span>
<span class="linenos">457</span>        <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">458</span>        <span class="s2">&quot;trust_remote_code&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">459</span>    <span class="p">}</span>
<span class="linenos">460</span>    <span class="k">if</span> <span class="n">model_args</span><span class="o">.</span><span class="n">config_name</span><span class="p">:</span>
<span class="linenos">461</span>        <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_args</span><span class="o">.</span><span class="n">config_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config_kwargs</span><span class="p">)</span>
<span class="linenos">462</span>    <span class="k">elif</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">:</span>
<span class="linenos">463</span>        <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">config_kwargs</span><span class="p">)</span>
<span class="linenos">464</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">465</span>        <span class="n">config</span> <span class="o">=</span> <span class="n">CONFIG_MAPPING</span><span class="p">[</span><span class="n">model_args</span><span class="o">.</span><span class="n">model_type</span><span class="p">]()</span>
<span class="linenos">466</span>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You are instantiating a new config instance from scratch.&quot;</span><span class="p">)</span>
<span class="linenos">467</span>        <span class="k">if</span> <span class="n">model_args</span><span class="o">.</span><span class="n">config_overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">468</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overriding config: </span><span class="si">{</span><span class="n">model_args</span><span class="o">.</span><span class="n">config_overrides</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">469</span>            <span class="n">config</span><span class="o">.</span><span class="n">update_from_string</span><span class="p">(</span><span class="n">model_args</span><span class="o">.</span><span class="n">config_overrides</span><span class="p">)</span>
<span class="linenos">470</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">471</span>
<span class="linenos">472</span>    <span class="n">tokenizer_kwargs</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">473</span>        <span class="s2">&quot;cache_dir&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">474</span>        <span class="s2">&quot;use_fast&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">use_fast_tokenizer</span><span class="p">,</span>
<span class="linenos">475</span>        <span class="s2">&quot;revision&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_revision</span><span class="p">,</span>
<span class="linenos">476</span>        <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">477</span>        <span class="s2">&quot;trust_remote_code&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">478</span>    <span class="p">}</span>
<span class="linenos">479</span>    <span class="k">if</span> <span class="n">model_args</span><span class="o">.</span><span class="n">tokenizer_name</span><span class="p">:</span>
<span class="linenos">480</span>        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_args</span><span class="o">.</span><span class="n">tokenizer_name</span><span class="p">,</span> <span class="o">**</span><span class="n">tokenizer_kwargs</span><span class="p">)</span>
<span class="linenos">481</span>    <span class="k">elif</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">:</span>
<span class="linenos">482</span>        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">tokenizer_kwargs</span><span class="p">)</span>
<span class="linenos">483</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">484</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">485</span>            <span class="s2">&quot;You are instantiating a new tokenizer from scratch. This is not supported by this script. &quot;</span>
<span class="linenos">486</span>            <span class="s2">&quot;You can do it from another script, save it, and load it from here, using --tokenizer_name.&quot;</span>
<span class="linenos">487</span>        <span class="p">)</span>
<span class="linenos">488</span>
<span class="linenos">489</span>    <span class="k">if</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">:</span>
<span class="linenos">490</span>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">model_args</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">model_args</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">model_args</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">491</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos">492</span>            <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
<span class="linenos">493</span>            <span class="n">from_tf</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="s2">&quot;.ckpt&quot;</span> <span class="ow">in</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">),</span>
<span class="linenos">494</span>            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<span class="linenos">495</span>            <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos">496</span>            <span class="n">revision</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">model_revision</span><span class="p">,</span>
<span class="linenos">497</span>            <span class="n">token</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
<span class="linenos">498</span>            <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
<span class="linenos">499</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">500</span>        <span class="p">)</span>
<span class="linenos">501</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">502</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">)</span>
<span class="linenos">503</span>        <span class="n">n_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()}</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="linenos">504</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training new model from scratch - Total size=</span><span class="si">{</span><span class="n">n_params</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">M params&quot;</span><span class="p">)</span>
<span class="linenos">505</span>
<span class="linenos">506</span>    <span class="c1"># We resize the embeddings only when necessary to avoid index errors. If you are creating a model from scratch</span>
<span class="linenos">507</span>    <span class="c1"># on a small vocab and want a smaller embedding size, remove this test.</span>
<span class="linenos">508</span>    <span class="n">embedding_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">509</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">embedding_size</span><span class="p">:</span>
<span class="linenos">510</span>        <span class="n">model</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">))</span>
<span class="linenos">511</span>
<span class="linenos">512</span>    <span class="c1"># Preprocessing the datasets.</span>
<span class="linenos">513</span>    <span class="c1"># First we tokenize all the texts.</span>
<span class="linenos">514</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
<span class="linenos">515</span>        <span class="n">column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="linenos">516</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">517</span>        <span class="n">column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="linenos">518</span>    <span class="n">text_column_name</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">else</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">519</span>
<span class="linenos">520</span>    <span class="c1"># since this will be pickled to avoid _LazyModule error in Hasher force logger loading before tokenize_function</span>
<span class="linenos">521</span>    <span class="n">tok_logger</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;transformers.tokenization_utils_base&quot;</span><span class="p">)</span>
<span class="linenos">522</span>
<span class="linenos">523</span>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_function</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
<span class="linenos">524</span>        <span class="k">with</span> <span class="n">CaptureLogger</span><span class="p">(</span><span class="n">tok_logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">cl</span><span class="p">:</span>
<span class="linenos">525</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">text_column_name</span><span class="p">])</span>
<span class="linenos">526</span>        <span class="c1"># clm input could be much much longer than block_size</span>
<span class="linenos">527</span>        <span class="k">if</span> <span class="s2">&quot;Token indices sequence length is longer than the&quot;</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
<span class="linenos">528</span>            <span class="n">tok_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">529</span>                <span class="s2">&quot;^^^^^^^^^^^^^^^^ Please ignore the warning above - this long input will be chunked into smaller bits&quot;</span>
<span class="linenos">530</span>                <span class="s2">&quot; before being passed to the model.&quot;</span>
<span class="linenos">531</span>            <span class="p">)</span>
<span class="linenos">532</span>        <span class="k">return</span> <span class="n">output</span>
<span class="linenos">533</span>
<span class="linenos">534</span>    <span class="k">with</span> <span class="n">training_args</span><span class="o">.</span><span class="n">main_process_first</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;dataset map tokenization&quot;</span><span class="p">):</span>
<span class="linenos">535</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">536</span>            <span class="n">tokenized_datasets</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="linenos">537</span>                <span class="n">tokenize_function</span><span class="p">,</span>
<span class="linenos">538</span>                <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">539</span>                <span class="n">num_proc</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">preprocessing_num_workers</span><span class="p">,</span>
<span class="linenos">540</span>                <span class="n">remove_columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span>
<span class="linenos">541</span>                <span class="n">load_from_cache_file</span><span class="o">=</span><span class="ow">not</span> <span class="n">data_args</span><span class="o">.</span><span class="n">overwrite_cache</span><span class="p">,</span>
<span class="linenos">542</span>                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Running tokenizer on dataset&quot;</span><span class="p">,</span>
<span class="linenos">543</span>            <span class="p">)</span>
<span class="linenos">544</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">545</span>            <span class="n">tokenized_datasets</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="linenos">546</span>                <span class="n">tokenize_function</span><span class="p">,</span>
<span class="linenos">547</span>                <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">548</span>                <span class="n">remove_columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span>
<span class="linenos">549</span>            <span class="p">)</span>
<span class="linenos">550</span>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;max_position_embeddings&quot;</span><span class="p">):</span>
<span class="linenos">551</span>        <span class="n">max_pos_embeddings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_position_embeddings</span>
<span class="linenos">552</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">553</span>        <span class="c1"># Define a default value if the attribute is missing in the config.</span>
<span class="linenos">554</span>        <span class="n">max_pos_embeddings</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="linenos">555</span>
<span class="linenos">556</span>    <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">block_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">557</span>        <span class="n">block_size</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span>
<span class="linenos">558</span>        <span class="k">if</span> <span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">max_pos_embeddings</span><span class="p">:</span>
<span class="linenos">559</span>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">560</span>                <span class="sa">f</span><span class="s2">&quot;The tokenizer picked seems to have a very large `model_max_length` (</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="si">}</span><span class="s2">). &quot;</span>
<span class="linenos">561</span>                <span class="sa">f</span><span class="s2">&quot;Using block_size=</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">max_pos_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead. You can change that default value by passing --block_size xxx.&quot;</span>
<span class="linenos">562</span>            <span class="p">)</span>
<span class="linenos">563</span>            <span class="k">if</span> <span class="n">max_pos_embeddings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">564</span>                <span class="n">block_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">max_pos_embeddings</span><span class="p">)</span>
<span class="linenos">565</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">566</span>                <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="linenos">567</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">568</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">:</span>
<span class="linenos">569</span>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">570</span>                <span class="sa">f</span><span class="s2">&quot;The block_size passed (</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">block_size</span><span class="si">}</span><span class="s2">) is larger than the maximum length for the model &quot;</span>
<span class="linenos">571</span>                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="si">}</span><span class="s2">). Using block_size=</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="linenos">572</span>            <span class="p">)</span>
<span class="linenos">573</span>        <span class="n">block_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_args</span><span class="o">.</span><span class="n">block_size</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">)</span>
<span class="linenos">574</span>
<span class="linenos">575</span>    <span class="c1"># Main data processing function that will concatenate all texts from our dataset and generate chunks of block_size.</span>
<span class="linenos">576</span>    <span class="k">def</span><span class="w"> </span><span class="nf">group_texts</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
<span class="linenos">577</span>        <span class="c1"># Concatenate all texts.</span>
<span class="linenos">578</span>        <span class="n">concatenated_examples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">examples</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">}</span>
<span class="linenos">579</span>        <span class="n">total_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatenated_examples</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>
<span class="linenos">580</span>        <span class="c1"># We drop the small remainder, and if the total_length &lt; block_size  we exclude this batch and return an empty dict.</span>
<span class="linenos">581</span>        <span class="c1"># We could add padding if the model supported it instead of this drop, you can customize this part to your needs.</span>
<span class="linenos">582</span>        <span class="n">total_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_length</span> <span class="o">//</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_size</span>
<span class="linenos">583</span>        <span class="c1"># Split by chunks of max_len.</span>
<span class="linenos">584</span>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">585</span>            <span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_length</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)]</span>
<span class="linenos">586</span>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">concatenated_examples</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos">587</span>        <span class="p">}</span>
<span class="linenos">588</span>        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">589</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos">590</span>
<span class="linenos">591</span>    <span class="c1"># Note that with `batched=True`, this map processes 1,000 texts together, so group_texts throws away a remainder</span>
<span class="linenos">592</span>    <span class="c1"># for each of those groups of 1,000 texts. You can adjust that batch_size here but a higher value might be slower</span>
<span class="linenos">593</span>    <span class="c1"># to preprocess.</span>
<span class="linenos">594</span>    <span class="c1">#</span>
<span class="linenos">595</span>    <span class="c1"># To speed up this part, we use multiprocessing. See the documentation of the map method for more information:</span>
<span class="linenos">596</span>    <span class="c1"># https://huggingface.co/docs/datasets/process#map</span>
<span class="linenos">597</span>
<span class="linenos">598</span>    <span class="k">with</span> <span class="n">training_args</span><span class="o">.</span><span class="n">main_process_first</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;grouping texts together&quot;</span><span class="p">):</span>
<span class="linenos">599</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">600</span>            <span class="n">lm_datasets</span> <span class="o">=</span> <span class="n">tokenized_datasets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="linenos">601</span>                <span class="n">group_texts</span><span class="p">,</span>
<span class="linenos">602</span>                <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">603</span>                <span class="n">num_proc</span><span class="o">=</span><span class="n">data_args</span><span class="o">.</span><span class="n">preprocessing_num_workers</span><span class="p">,</span>
<span class="linenos">604</span>                <span class="n">load_from_cache_file</span><span class="o">=</span><span class="ow">not</span> <span class="n">data_args</span><span class="o">.</span><span class="n">overwrite_cache</span><span class="p">,</span>
<span class="linenos">605</span>                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Grouping texts in chunks of </span><span class="si">{</span><span class="n">block_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos">606</span>            <span class="p">)</span>
<span class="linenos">607</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">608</span>            <span class="n">lm_datasets</span> <span class="o">=</span> <span class="n">tokenized_datasets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="linenos">609</span>                <span class="n">group_texts</span><span class="p">,</span>
<span class="linenos">610</span>                <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">611</span>            <span class="p">)</span>
<span class="linenos">612</span>
<span class="linenos">613</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
<span class="linenos">614</span>        <span class="k">if</span> <span class="s2">&quot;train&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tokenized_datasets</span><span class="p">:</span>
<span class="linenos">615</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--do_train requires a train dataset&quot;</span><span class="p">)</span>
<span class="linenos">616</span>        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">lm_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
<span class="linenos">617</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_train_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">618</span>            <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">619</span>                <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_args</span><span class="o">.</span><span class="n">max_train_samples</span><span class="p">)</span>
<span class="linenos">620</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">621</span>                <span class="n">max_train_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_train_samples</span><span class="p">)</span>
<span class="linenos">622</span>                <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_train_samples</span><span class="p">))</span>
<span class="linenos">623</span>
<span class="linenos">624</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
<span class="linenos">625</span>        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tokenized_datasets</span><span class="p">:</span>
<span class="linenos">626</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--do_eval requires a validation dataset&quot;</span><span class="p">)</span>
<span class="linenos">627</span>        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">lm_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span>
<span class="linenos">628</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_eval_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">629</span>            <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">630</span>                <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_args</span><span class="o">.</span><span class="n">max_eval_samples</span><span class="p">)</span>
<span class="linenos">631</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">632</span>                <span class="n">max_eval_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">),</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_eval_samples</span><span class="p">)</span>
<span class="linenos">633</span>                <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_eval_samples</span><span class="p">))</span>
<span class="linenos">634</span>
<span class="linenos">635</span>        <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_logits_for_metrics</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="linenos">636</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="linenos">637</span>                <span class="c1"># Depending on the model and config, logits may contain extra tensors,</span>
<span class="linenos">638</span>                <span class="c1"># like past_key_values, but logits always come first</span>
<span class="linenos">639</span>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">640</span>            <span class="k">return</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">641</span>
<span class="linenos">642</span>        <span class="n">metric</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">model_args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>
<span class="linenos">643</span>
<span class="linenos">644</span>        <span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">):</span>
<span class="linenos">645</span>            <span class="n">preds</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_preds</span>
<span class="linenos">646</span>            <span class="c1"># preds have the same shape as the labels, after the argmax(-1) has been calculated</span>
<span class="linenos">647</span>            <span class="c1"># by preprocess_logits_for_metrics but we need to shift the labels</span>
<span class="linenos">648</span>            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">649</span>            <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">650</span>            <span class="k">return</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="linenos">651</span>
<span class="linenos">652</span>    <span class="c1"># Initialize our Trainer</span>
<span class="linenos">653</span>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
<span class="linenos">654</span>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">655</span>        <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
<span class="linenos">656</span>        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span> <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">657</span>        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span> <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">658</span>        <span class="n">processing_class</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos">659</span>        <span class="c1"># Data collator will default to DataCollatorWithPadding, so we change it.</span>
<span class="linenos">660</span>        <span class="n">data_collator</span><span class="o">=</span><span class="n">default_data_collator</span><span class="p">,</span>
<span class="linenos">661</span>        <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span> <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_torch_xla_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">662</span>        <span class="n">preprocess_logits_for_metrics</span><span class="o">=</span><span class="n">preprocess_logits_for_metrics</span>
<span class="linenos">663</span>        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_torch_xla_available</span><span class="p">()</span>
<span class="linenos">664</span>        <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">665</span>    <span class="p">)</span>
<span class="linenos">666</span>
<span class="linenos">667</span>    <span class="c1"># Training</span>
<span class="linenos">668</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
<span class="linenos">669</span>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">670</span>        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">671</span>            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">training_args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span>
<span class="linenos">672</span>        <span class="k">elif</span> <span class="n">last_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">673</span>            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">last_checkpoint</span>
<span class="linenos">674</span>        <span class="n">train_result</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos">675</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>  <span class="c1"># Saves the tokenizer too for easy upload</span>
<span class="linenos">676</span>
<span class="linenos">677</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">train_result</span><span class="o">.</span><span class="n">metrics</span>
<span class="linenos">678</span>
<span class="linenos">679</span>        <span class="n">max_train_samples</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">680</span>            <span class="n">data_args</span><span class="o">.</span><span class="n">max_train_samples</span> <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_train_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
<span class="linenos">681</span>        <span class="p">)</span>
<span class="linenos">682</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">683</span>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_train_samples</span>
<span class="linenos">684</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">685</span>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_train_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">))</span>
<span class="linenos">686</span>
<span class="linenos">687</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="linenos">688</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="linenos">689</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
<span class="linenos">690</span>
<span class="linenos">691</span>    <span class="c1"># Evaluation</span>
<span class="linenos">692</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
<span class="linenos">693</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** Evaluate ***&quot;</span><span class="p">)</span>
<span class="linenos">694</span>
<span class="linenos">695</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
<span class="linenos">696</span>
<span class="linenos">697</span>        <span class="n">max_eval_samples</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_eval_samples</span> <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">max_eval_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
<span class="linenos">698</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
<span class="linenos">699</span>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_eval_samples</span>
<span class="linenos">700</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">701</span>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_eval_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">))</span>
<span class="linenos">702</span>
<span class="linenos">703</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">704</span>            <span class="n">perplexity</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_loss&quot;</span><span class="p">])</span>
<span class="linenos">705</span>        <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
<span class="linenos">706</span>            <span class="n">perplexity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
<span class="linenos">707</span>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;perplexity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perplexity</span>
<span class="linenos">708</span>
<span class="linenos">709</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="linenos">710</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="linenos">711</span>
<span class="linenos">712</span>    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;finetuned_from&quot;</span><span class="p">:</span> <span class="n">model_args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="s2">&quot;tasks&quot;</span><span class="p">:</span> <span class="s2">&quot;text-generation&quot;</span><span class="p">}</span>
<span class="linenos">713</span>    <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">714</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dataset_tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span>
<span class="linenos">715</span>        <span class="k">if</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">716</span>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dataset_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span>
<span class="linenos">717</span>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">data_args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">718</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">719</span>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_args</span><span class="o">.</span><span class="n">dataset_name</span>
<span class="linenos">720</span>
<span class="linenos">721</span>    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">:</span>
<span class="linenos">722</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">723</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">724</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">create_model_card</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">725</span>
<span class="linenos">726</span>
<span class="linenos">727</span><span class="k">def</span><span class="w"> </span><span class="nf">_mp_fn</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
<span class="linenos">728</span>    <span class="c1"># For xla_spawn (TPUs)</span>
<span class="linenos">729</span>    <span class="n">main</span><span class="p">()</span>
<span class="linenos">730</span>
<span class="linenos">731</span>
<span class="linenos">732</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">733</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>python<span class="w"> </span>run_clm.py<span class="w"> </span><span class="se">\</span>
<span class="linenos">2</span><span class="w">    </span>--model_name_or_path<span class="w"> </span>openai-community/gpt2<span class="w"> </span><span class="se">\</span>
<span class="linenos">3</span><span class="w">    </span>--train_file<span class="w"> </span>path_to_train_file<span class="w"> </span><span class="se">\</span>
<span class="linenos">4</span><span class="w">    </span>--validation_file<span class="w"> </span>path_to_validation_file<span class="w"> </span><span class="se">\</span>
<span class="linenos">5</span><span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">6</span><span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">7</span><span class="w">    </span>--do_train<span class="w"> </span><span class="se">\</span>
<span class="linenos">8</span><span class="w">    </span>--do_eval<span class="w"> </span><span class="se">\</span>
<span class="linenos">9</span><span class="w">    </span>--output_dir<span class="w"> </span>/tmp/test-clm
</pre></div>
</div>
</section>
<section id="diffusers">
<h2>4. 使用Diffusers进行模型微调<a class="headerlink" href="#diffusers" title="Link to this heading"></a></h2>
<p>以下代码使用了Diffusers对文生图模型进行微调（来自 <a class="reference external" href="https://github.com/huggingface/diffusers/blob/main/examples/text_to_image/train_text_to_image.py">diffusers examples</a>），自diffusers v0.27.0版本以后，代码无需任何修改，即可自动检测NPU并进行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">   2</span><span class="c1"># coding=utf-8</span>
<span class="linenos">   3</span><span class="c1"># Copyright 2025 The HuggingFace Inc. team. All rights reserved.</span>
<span class="linenos">   4</span><span class="c1">#</span>
<span class="linenos">   5</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">   6</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">   7</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">   8</span><span class="c1">#</span>
<span class="linenos">   9</span><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  10</span><span class="c1">#</span>
<span class="linenos">  11</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos">  12</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos">  13</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos">  14</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos">  15</span><span class="c1"># limitations under the License.</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="linenos">  18</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">  19</span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="linenos">  20</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos">  21</span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="linenos">  22</span><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="linenos">  23</span><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">nullcontext</span>
<span class="linenos">  24</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="linenos">  25</span>
<span class="linenos">  26</span><span class="kn">import</span><span class="w"> </span><span class="nn">accelerate</span>
<span class="linenos">  27</span><span class="kn">import</span><span class="w"> </span><span class="nn">datasets</span>
<span class="linenos">  28</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">  29</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos">  30</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="linenos">  31</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.checkpoint</span>
<span class="linenos">  32</span><span class="kn">import</span><span class="w"> </span><span class="nn">transformers</span>
<span class="linenos">  33</span><span class="kn">from</span><span class="w"> </span><span class="nn">accelerate</span><span class="w"> </span><span class="kn">import</span> <span class="n">Accelerator</span>
<span class="linenos">  34</span><span class="kn">from</span><span class="w"> </span><span class="nn">accelerate.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="linenos">  35</span><span class="kn">from</span><span class="w"> </span><span class="nn">accelerate.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcceleratorState</span>
<span class="linenos">  36</span><span class="kn">from</span><span class="w"> </span><span class="nn">accelerate.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectConfiguration</span><span class="p">,</span> <span class="n">set_seed</span>
<span class="linenos">  37</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>
<span class="linenos">  38</span><span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_repo</span><span class="p">,</span> <span class="n">upload_folder</span>
<span class="linenos">  39</span><span class="kn">from</span><span class="w"> </span><span class="nn">packaging</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
<span class="linenos">  40</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="linenos">  41</span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="linenos">  42</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">CLIPTextModel</span><span class="p">,</span> <span class="n">CLIPTokenizer</span>
<span class="linenos">  43</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextManagers</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="kn">import</span><span class="w"> </span><span class="nn">diffusers</span>
<span class="linenos">  46</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoencoderKL</span><span class="p">,</span> <span class="n">DDPMScheduler</span><span class="p">,</span> <span class="n">StableDiffusionPipeline</span><span class="p">,</span> <span class="n">UNet2DConditionModel</span>
<span class="linenos">  47</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_scheduler</span>
<span class="linenos">  48</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.training_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">EMAModel</span><span class="p">,</span> <span class="n">compute_dream_and_update_latents</span><span class="p">,</span> <span class="n">compute_snr</span>
<span class="linenos">  49</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_min_version</span><span class="p">,</span> <span class="n">deprecate</span><span class="p">,</span> <span class="n">is_wandb_available</span><span class="p">,</span> <span class="n">make_image_grid</span>
<span class="linenos">  50</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.utils.hub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_or_create_model_card</span><span class="p">,</span> <span class="n">populate_model_card</span>
<span class="linenos">  51</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.utils.import_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_xformers_available</span>
<span class="linenos">  52</span><span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.utils.torch_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_compiled_module</span>
<span class="linenos">  53</span>
<span class="linenos">  54</span>
<span class="linenos">  55</span><span class="k">if</span> <span class="n">is_wandb_available</span><span class="p">():</span>
<span class="linenos">  56</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">wandb</span>
<span class="linenos">  57</span>
<span class="linenos">  58</span>
<span class="linenos">  59</span><span class="c1"># Will error if the minimal version of diffusers is not installed. Remove at your own risks.</span>
<span class="linenos">  60</span><span class="n">check_min_version</span><span class="p">(</span><span class="s2">&quot;0.36.0.dev0&quot;</span><span class="p">)</span>
<span class="linenos">  61</span>
<span class="linenos">  62</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
<span class="linenos">  63</span>
<span class="linenos">  64</span><span class="n">DATASET_NAME_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  65</span>    <span class="s2">&quot;lambdalabs/naruto-blip-captions&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">),</span>
<span class="linenos">  66</span><span class="p">}</span>
<span class="linenos">  67</span>
<span class="linenos">  68</span>
<span class="linenos">  69</span><span class="k">def</span><span class="w"> </span><span class="nf">save_model_card</span><span class="p">(</span>
<span class="linenos">  70</span>    <span class="n">args</span><span class="p">,</span>
<span class="linenos">  71</span>    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">  72</span>    <span class="n">images</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  73</span>    <span class="n">repo_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  74</span><span class="p">):</span>
<span class="linenos">  75</span>    <span class="n">img_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">  76</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">  77</span>        <span class="n">image_grid</span> <span class="o">=</span> <span class="n">make_image_grid</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">))</span>
<span class="linenos">  78</span>        <span class="n">image_grid</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repo_folder</span><span class="p">,</span> <span class="s2">&quot;val_imgs_grid.png&quot;</span><span class="p">))</span>
<span class="linenos">  79</span>        <span class="n">img_str</span> <span class="o">+=</span> <span class="s2">&quot;![val_imgs_grid](./val_imgs_grid.png)</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span>    <span class="n">model_description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos">  82</span><span class="s2"># Text-to-image finetuning - </span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span>
<span class="linenos">  83</span>
<span class="linenos">  84</span><span class="s2">This pipeline was finetuned from **</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="si">}</span><span class="s2">** on the **</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">** dataset. Below are some example images generated with the finetuned pipeline using the following prompts: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span>
<span class="linenos">  85</span><span class="si">{</span><span class="n">img_str</span><span class="si">}</span>
<span class="linenos">  86</span>
<span class="linenos">  87</span><span class="s2">## Pipeline usage</span>
<span class="linenos">  88</span>
<span class="linenos">  89</span><span class="s2">You can use the pipeline like so:</span>
<span class="linenos">  90</span>
<span class="linenos">  91</span><span class="s2">```python</span>
<span class="linenos">  92</span><span class="s2">from diffusers import DiffusionPipeline</span>
<span class="linenos">  93</span><span class="s2">import torch</span>
<span class="linenos">  94</span>
<span class="linenos">  95</span><span class="s2">pipeline = DiffusionPipeline.from_pretrained(&quot;</span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span><span class="s2">&quot;, torch_dtype=torch.float16)</span>
<span class="linenos">  96</span><span class="s2">prompt = &quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">  97</span><span class="s2">image = pipeline(prompt).images[0]</span>
<span class="linenos">  98</span><span class="s2">image.save(&quot;my_image.png&quot;)</span>
<span class="linenos">  99</span><span class="s2">```</span>
<span class="linenos"> 100</span>
<span class="linenos"> 101</span><span class="s2">## Training info</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span><span class="s2">These are the key hyperparameters used during training:</span>
<span class="linenos"> 104</span>
<span class="linenos"> 105</span><span class="s2">* Epochs: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="si">}</span>
<span class="linenos"> 106</span><span class="s2">* Learning rate: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="si">}</span>
<span class="linenos"> 107</span><span class="s2">* Batch size: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="si">}</span>
<span class="linenos"> 108</span><span class="s2">* Gradient accumulation steps: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="si">}</span>
<span class="linenos"> 109</span><span class="s2">* Image resolution: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">resolution</span><span class="si">}</span>
<span class="linenos"> 110</span><span class="s2">* Mixed-precision: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">mixed_precision</span><span class="si">}</span>
<span class="linenos"> 111</span>
<span class="linenos"> 112</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 113</span>    <span class="n">wandb_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 114</span>    <span class="k">if</span> <span class="n">is_wandb_available</span><span class="p">():</span>
<span class="linenos"> 115</span>        <span class="n">wandb_run_url</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 116</span>        <span class="k">if</span> <span class="n">wandb</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 117</span>            <span class="n">wandb_run_url</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">url</span>
<span class="linenos"> 118</span>
<span class="linenos"> 119</span>    <span class="k">if</span> <span class="n">wandb_run_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 120</span>        <span class="n">wandb_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 121</span><span class="s2">More information on all the CLI arguments and the environment are available on your [`wandb` run page](</span><span class="si">{</span><span class="n">wandb_run_url</span><span class="si">}</span><span class="s2">).</span>
<span class="linenos"> 122</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 123</span>
<span class="linenos"> 124</span>    <span class="n">model_description</span> <span class="o">+=</span> <span class="n">wandb_info</span>
<span class="linenos"> 125</span>
<span class="linenos"> 126</span>    <span class="n">model_card</span> <span class="o">=</span> <span class="n">load_or_create_model_card</span><span class="p">(</span>
<span class="linenos"> 127</span>        <span class="n">repo_id_or_path</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
<span class="linenos"> 128</span>        <span class="n">from_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 129</span>        <span class="n">license</span><span class="o">=</span><span class="s2">&quot;creativeml-openrail-m&quot;</span><span class="p">,</span>
<span class="linenos"> 130</span>        <span class="n">base_model</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span>
<span class="linenos"> 131</span>        <span class="n">model_description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
<span class="linenos"> 132</span>        <span class="n">inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 133</span>    <span class="p">)</span>
<span class="linenos"> 134</span>
<span class="linenos"> 135</span>    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stable-diffusion&quot;</span><span class="p">,</span> <span class="s2">&quot;stable-diffusion-diffusers&quot;</span><span class="p">,</span> <span class="s2">&quot;text-to-image&quot;</span><span class="p">,</span> <span class="s2">&quot;diffusers&quot;</span><span class="p">,</span> <span class="s2">&quot;diffusers-training&quot;</span><span class="p">]</span>
<span class="linenos"> 136</span>    <span class="n">model_card</span> <span class="o">=</span> <span class="n">populate_model_card</span><span class="p">(</span><span class="n">model_card</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 137</span>
<span class="linenos"> 138</span>    <span class="n">model_card</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repo_folder</span><span class="p">,</span> <span class="s2">&quot;README.md&quot;</span><span class="p">))</span>
<span class="linenos"> 139</span>
<span class="linenos"> 140</span>
<span class="linenos"> 141</span><span class="k">def</span><span class="w"> </span><span class="nf">log_validation</span><span class="p">(</span><span class="n">vae</span><span class="p">,</span> <span class="n">text_encoder</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">unet</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">accelerator</span><span class="p">,</span> <span class="n">weight_dtype</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<span class="linenos"> 142</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running validation... &quot;</span><span class="p">)</span>
<span class="linenos"> 143</span>
<span class="linenos"> 144</span>    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">StableDiffusionPipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 145</span>        <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span>
<span class="linenos"> 146</span>        <span class="n">vae</span><span class="o">=</span><span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span><span class="n">vae</span><span class="p">),</span>
<span class="linenos"> 147</span>        <span class="n">text_encoder</span><span class="o">=</span><span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span><span class="n">text_encoder</span><span class="p">),</span>
<span class="linenos"> 148</span>        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos"> 149</span>        <span class="n">unet</span><span class="o">=</span><span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span><span class="n">unet</span><span class="p">),</span>
<span class="linenos"> 150</span>        <span class="n">safety_checker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 151</span>        <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
<span class="linenos"> 152</span>        <span class="n">variant</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">variant</span><span class="p">,</span>
<span class="linenos"> 153</span>        <span class="n">torch_dtype</span><span class="o">=</span><span class="n">weight_dtype</span><span class="p">,</span>
<span class="linenos"> 154</span>    <span class="p">)</span>
<span class="linenos"> 155</span>    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos"> 156</span>    <span class="n">pipeline</span><span class="o">.</span><span class="n">set_progress_bar_config</span><span class="p">(</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 157</span>
<span class="linenos"> 158</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">:</span>
<span class="linenos"> 159</span>        <span class="n">pipeline</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">()</span>
<span class="linenos"> 160</span>
<span class="linenos"> 161</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 162</span>        <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 163</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 164</span>        <span class="n">generator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos"> 165</span>
<span class="linenos"> 166</span>    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 167</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">)):</span>
<span class="linenos"> 168</span>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<span class="linenos"> 169</span>            <span class="n">autocast_ctx</span> <span class="o">=</span> <span class="n">nullcontext</span><span class="p">()</span>
<span class="linenos"> 170</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 171</span>            <span class="n">autocast_ctx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<span class="linenos"> 172</span>
<span class="linenos"> 173</span>        <span class="k">with</span> <span class="n">autocast_ctx</span><span class="p">:</span>
<span class="linenos"> 174</span>            <span class="n">image</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_inference_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 175</span>
<span class="linenos"> 176</span>        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="linenos"> 177</span>
<span class="linenos"> 178</span>    <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
<span class="linenos"> 179</span>        <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;tensorboard&quot;</span><span class="p">:</span>
<span class="linenos"> 180</span>            <span class="n">np_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">])</span>
<span class="linenos"> 181</span>            <span class="n">tracker</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="n">np_images</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">dataformats</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">)</span>
<span class="linenos"> 182</span>        <span class="k">elif</span> <span class="n">tracker</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;wandb&quot;</span><span class="p">:</span>
<span class="linenos"> 183</span>            <span class="n">tracker</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
<span class="linenos"> 184</span>                <span class="p">{</span>
<span class="linenos"> 185</span>                    <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos"> 186</span>                        <span class="n">wandb</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 187</span>                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="linenos"> 188</span>                    <span class="p">]</span>
<span class="linenos"> 189</span>                <span class="p">}</span>
<span class="linenos"> 190</span>            <span class="p">)</span>
<span class="linenos"> 191</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 192</span>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image logging not implemented for </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 193</span>
<span class="linenos"> 194</span>    <span class="k">del</span> <span class="n">pipeline</span>
<span class="linenos"> 195</span>    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="linenos"> 196</span>
<span class="linenos"> 197</span>    <span class="k">return</span> <span class="n">images</span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span>
<span class="linenos"> 200</span><span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">():</span>
<span class="linenos"> 201</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Simple example of a training script.&quot;</span><span class="p">)</span>
<span class="linenos"> 202</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 203</span>        <span class="s2">&quot;--input_perturbation&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The scale of input perturbation. Recommended 0.1.&quot;</span>
<span class="linenos"> 204</span>    <span class="p">)</span>
<span class="linenos"> 205</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 206</span>        <span class="s2">&quot;--pretrained_model_name_or_path&quot;</span><span class="p">,</span>
<span class="linenos"> 207</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 208</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 209</span>        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 210</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to pretrained model or model identifier from huggingface.co/models.&quot;</span><span class="p">,</span>
<span class="linenos"> 211</span>    <span class="p">)</span>
<span class="linenos"> 212</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 213</span>        <span class="s2">&quot;--revision&quot;</span><span class="p">,</span>
<span class="linenos"> 214</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 215</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 216</span>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 217</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Revision of pretrained model identifier from huggingface.co/models.&quot;</span><span class="p">,</span>
<span class="linenos"> 218</span>    <span class="p">)</span>
<span class="linenos"> 219</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 220</span>        <span class="s2">&quot;--variant&quot;</span><span class="p">,</span>
<span class="linenos"> 221</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 222</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 223</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Variant of the model files of the pretrained model identifier from huggingface.co/models, &#39;e.g.&#39; fp16&quot;</span><span class="p">,</span>
<span class="linenos"> 224</span>    <span class="p">)</span>
<span class="linenos"> 225</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 226</span>        <span class="s2">&quot;--dataset_name&quot;</span><span class="p">,</span>
<span class="linenos"> 227</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 228</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 229</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 230</span>            <span class="s2">&quot;The name of the Dataset (from the HuggingFace hub) to train on (could be your own, possibly private,&quot;</span>
<span class="linenos"> 231</span>            <span class="s2">&quot; dataset). It can also be a path pointing to a local copy of a dataset in your filesystem,&quot;</span>
<span class="linenos"> 232</span>            <span class="s2">&quot; or to a folder containing files that 🤗 Datasets can understand.&quot;</span>
<span class="linenos"> 233</span>        <span class="p">),</span>
<span class="linenos"> 234</span>    <span class="p">)</span>
<span class="linenos"> 235</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 236</span>        <span class="s2">&quot;--dataset_config_name&quot;</span><span class="p">,</span>
<span class="linenos"> 237</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 238</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 239</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The config of the Dataset, leave as None if there&#39;s only one config.&quot;</span><span class="p">,</span>
<span class="linenos"> 240</span>    <span class="p">)</span>
<span class="linenos"> 241</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 242</span>        <span class="s2">&quot;--train_data_dir&quot;</span><span class="p">,</span>
<span class="linenos"> 243</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 244</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 245</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 246</span>            <span class="s2">&quot;A folder containing the training data. Folder contents must follow the structure described in&quot;</span>
<span class="linenos"> 247</span>            <span class="s2">&quot; https://huggingface.co/docs/datasets/image_dataset#imagefolder. In particular, a `metadata.jsonl` file&quot;</span>
<span class="linenos"> 248</span>            <span class="s2">&quot; must exist to provide the captions for the images. Ignored if `dataset_name` is specified.&quot;</span>
<span class="linenos"> 249</span>        <span class="p">),</span>
<span class="linenos"> 250</span>    <span class="p">)</span>
<span class="linenos"> 251</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 252</span>        <span class="s2">&quot;--image_column&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The column of the dataset containing an image.&quot;</span>
<span class="linenos"> 253</span>    <span class="p">)</span>
<span class="linenos"> 254</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 255</span>        <span class="s2">&quot;--caption_column&quot;</span><span class="p">,</span>
<span class="linenos"> 256</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 257</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<span class="linenos"> 258</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The column of the dataset containing a caption or a list of captions.&quot;</span><span class="p">,</span>
<span class="linenos"> 259</span>    <span class="p">)</span>
<span class="linenos"> 260</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 261</span>        <span class="s2">&quot;--max_train_samples&quot;</span><span class="p">,</span>
<span class="linenos"> 262</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 263</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 264</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 265</span>            <span class="s2">&quot;For debugging purposes or quicker training, truncate the number of training examples to this &quot;</span>
<span class="linenos"> 266</span>            <span class="s2">&quot;value if set.&quot;</span>
<span class="linenos"> 267</span>        <span class="p">),</span>
<span class="linenos"> 268</span>    <span class="p">)</span>
<span class="linenos"> 269</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 270</span>        <span class="s2">&quot;--validation_prompts&quot;</span><span class="p">,</span>
<span class="linenos"> 271</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 272</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 273</span>        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
<span class="linenos"> 274</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;A set of prompts evaluated every `--validation_epochs` and logged to `--report_to`.&quot;</span><span class="p">),</span>
<span class="linenos"> 275</span>    <span class="p">)</span>
<span class="linenos"> 276</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 277</span>        <span class="s2">&quot;--output_dir&quot;</span><span class="p">,</span>
<span class="linenos"> 278</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 279</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;sd-model-finetuned&quot;</span><span class="p">,</span>
<span class="linenos"> 280</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output directory where the model predictions and checkpoints will be written.&quot;</span><span class="p">,</span>
<span class="linenos"> 281</span>    <span class="p">)</span>
<span class="linenos"> 282</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 283</span>        <span class="s2">&quot;--cache_dir&quot;</span><span class="p">,</span>
<span class="linenos"> 284</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 285</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 286</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The directory where the downloaded models and datasets will be stored.&quot;</span><span class="p">,</span>
<span class="linenos"> 287</span>    <span class="p">)</span>
<span class="linenos"> 288</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A seed for reproducible training.&quot;</span><span class="p">)</span>
<span class="linenos"> 289</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 290</span>        <span class="s2">&quot;--resolution&quot;</span><span class="p">,</span>
<span class="linenos"> 291</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 292</span>        <span class="n">default</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<span class="linenos"> 293</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 294</span>            <span class="s2">&quot;The resolution for input images, all the images in the train/validation dataset will be resized to this&quot;</span>
<span class="linenos"> 295</span>            <span class="s2">&quot; resolution&quot;</span>
<span class="linenos"> 296</span>        <span class="p">),</span>
<span class="linenos"> 297</span>    <span class="p">)</span>
<span class="linenos"> 298</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 299</span>        <span class="s2">&quot;--center_crop&quot;</span><span class="p">,</span>
<span class="linenos"> 300</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 301</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 302</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 303</span>            <span class="s2">&quot;Whether to center crop the input images to the resolution. If not set, the images will be randomly&quot;</span>
<span class="linenos"> 304</span>            <span class="s2">&quot; cropped. The images will be resized to the resolution first before cropping.&quot;</span>
<span class="linenos"> 305</span>        <span class="p">),</span>
<span class="linenos"> 306</span>    <span class="p">)</span>
<span class="linenos"> 307</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 308</span>        <span class="s2">&quot;--random_flip&quot;</span><span class="p">,</span>
<span class="linenos"> 309</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 310</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether to randomly flip images horizontally&quot;</span><span class="p">,</span>
<span class="linenos"> 311</span>    <span class="p">)</span>
<span class="linenos"> 312</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 313</span>        <span class="s2">&quot;--train_batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Batch size (per device) for the training dataloader.&quot;</span>
<span class="linenos"> 314</span>    <span class="p">)</span>
<span class="linenos"> 315</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_train_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 316</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 317</span>        <span class="s2">&quot;--max_train_steps&quot;</span><span class="p">,</span>
<span class="linenos"> 318</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 319</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 320</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Total number of training steps to perform.  If provided, overrides num_train_epochs.&quot;</span><span class="p">,</span>
<span class="linenos"> 321</span>    <span class="p">)</span>
<span class="linenos"> 322</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 323</span>        <span class="s2">&quot;--gradient_accumulation_steps&quot;</span><span class="p">,</span>
<span class="linenos"> 324</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 325</span>        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 326</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of updates steps to accumulate before performing a backward/update pass.&quot;</span><span class="p">,</span>
<span class="linenos"> 327</span>    <span class="p">)</span>
<span class="linenos"> 328</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 329</span>        <span class="s2">&quot;--gradient_checkpointing&quot;</span><span class="p">,</span>
<span class="linenos"> 330</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 331</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to use gradient checkpointing to save memory at the expense of slower backward pass.&quot;</span><span class="p">,</span>
<span class="linenos"> 332</span>    <span class="p">)</span>
<span class="linenos"> 333</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 334</span>        <span class="s2">&quot;--learning_rate&quot;</span><span class="p">,</span>
<span class="linenos"> 335</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 336</span>        <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
<span class="linenos"> 337</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial learning rate (after the potential warmup period) to use.&quot;</span><span class="p">,</span>
<span class="linenos"> 338</span>    <span class="p">)</span>
<span class="linenos"> 339</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 340</span>        <span class="s2">&quot;--scale_lr&quot;</span><span class="p">,</span>
<span class="linenos"> 341</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 342</span>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 343</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scale the learning rate by the number of GPUs, gradient accumulation steps, and batch size.&quot;</span><span class="p">,</span>
<span class="linenos"> 344</span>    <span class="p">)</span>
<span class="linenos"> 345</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 346</span>        <span class="s2">&quot;--lr_scheduler&quot;</span><span class="p">,</span>
<span class="linenos"> 347</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 348</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
<span class="linenos"> 349</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 350</span>            <span class="s1">&#39;The scheduler type to use. Choose between [&quot;linear&quot;, &quot;cosine&quot;, &quot;cosine_with_restarts&quot;, &quot;polynomial&quot;,&#39;</span>
<span class="linenos"> 351</span>            <span class="s1">&#39; &quot;constant&quot;, &quot;constant_with_warmup&quot;]&#39;</span>
<span class="linenos"> 352</span>        <span class="p">),</span>
<span class="linenos"> 353</span>    <span class="p">)</span>
<span class="linenos"> 354</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 355</span>        <span class="s2">&quot;--lr_warmup_steps&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of steps for the warmup in the lr scheduler.&quot;</span>
<span class="linenos"> 356</span>    <span class="p">)</span>
<span class="linenos"> 357</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 358</span>        <span class="s2">&quot;--snr_gamma&quot;</span><span class="p">,</span>
<span class="linenos"> 359</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 360</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 361</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SNR weighting gamma to be used if rebalancing the loss. Recommended value is 5.0. &quot;</span>
<span class="linenos"> 362</span>        <span class="s2">&quot;More details here: https://huggingface.co/papers/2303.09556.&quot;</span><span class="p">,</span>
<span class="linenos"> 363</span>    <span class="p">)</span>
<span class="linenos"> 364</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 365</span>        <span class="s2">&quot;--dream_training&quot;</span><span class="p">,</span>
<span class="linenos"> 366</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 367</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 368</span>            <span class="s2">&quot;Use the DREAM training method, which makes training more efficient and accurate at the &quot;</span>
<span class="linenos"> 369</span>            <span class="s2">&quot;expense of doing an extra forward pass. See: https://huggingface.co/papers/2312.00210&quot;</span>
<span class="linenos"> 370</span>        <span class="p">),</span>
<span class="linenos"> 371</span>    <span class="p">)</span>
<span class="linenos"> 372</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 373</span>        <span class="s2">&quot;--dream_detail_preservation&quot;</span><span class="p">,</span>
<span class="linenos"> 374</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 375</span>        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="linenos"> 376</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dream detail preservation factor p (should be greater than 0; default=1.0, as suggested in the paper)&quot;</span><span class="p">,</span>
<span class="linenos"> 377</span>    <span class="p">)</span>
<span class="linenos"> 378</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 379</span>        <span class="s2">&quot;--use_8bit_adam&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to use 8-bit Adam from bitsandbytes.&quot;</span>
<span class="linenos"> 380</span>    <span class="p">)</span>
<span class="linenos"> 381</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 382</span>        <span class="s2">&quot;--allow_tf32&quot;</span><span class="p">,</span>
<span class="linenos"> 383</span>        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
<span class="linenos"> 384</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 385</span>            <span class="s2">&quot;Whether or not to allow TF32 on Ampere GPUs. Can be used to speed up training. For more information, see&quot;</span>
<span class="linenos"> 386</span>            <span class="s2">&quot; https://pytorch.org/docs/stable/notes/cuda.html#tensorfloat-32-tf32-on-ampere-devices&quot;</span>
<span class="linenos"> 387</span>        <span class="p">),</span>
<span class="linenos"> 388</span>    <span class="p">)</span>
<span class="linenos"> 389</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_ema&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use EMA model.&quot;</span><span class="p">)</span>
<span class="linenos"> 390</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--offload_ema&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Offload EMA model to CPU during training step.&quot;</span><span class="p">)</span>
<span class="linenos"> 391</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--foreach_ema&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use faster foreach implementation of EMAModel.&quot;</span><span class="p">)</span>
<span class="linenos"> 392</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 393</span>        <span class="s2">&quot;--non_ema_revision&quot;</span><span class="p">,</span>
<span class="linenos"> 394</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 395</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 396</span>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 397</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 398</span>            <span class="s2">&quot;Revision of pretrained non-ema model identifier. Must be a branch, tag or git identifier of the local or&quot;</span>
<span class="linenos"> 399</span>            <span class="s2">&quot; remote repository specified with --pretrained_model_name_or_path.&quot;</span>
<span class="linenos"> 400</span>        <span class="p">),</span>
<span class="linenos"> 401</span>    <span class="p">)</span>
<span class="linenos"> 402</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 403</span>        <span class="s2">&quot;--dataloader_num_workers&quot;</span><span class="p">,</span>
<span class="linenos"> 404</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 405</span>        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 406</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 407</span>            <span class="s2">&quot;Number of subprocesses to use for data loading. 0 means that the data will be loaded in the main process.&quot;</span>
<span class="linenos"> 408</span>        <span class="p">),</span>
<span class="linenos"> 409</span>    <span class="p">)</span>
<span class="linenos"> 410</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--adam_beta1&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The beta1 parameter for the Adam optimizer.&quot;</span><span class="p">)</span>
<span class="linenos"> 411</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--adam_beta2&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The beta2 parameter for the Adam optimizer.&quot;</span><span class="p">)</span>
<span class="linenos"> 412</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--adam_weight_decay&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Weight decay to use.&quot;</span><span class="p">)</span>
<span class="linenos"> 413</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--adam_epsilon&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Epsilon value for the Adam optimizer&quot;</span><span class="p">)</span>
<span class="linenos"> 414</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max_grad_norm&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Max gradient norm.&quot;</span><span class="p">)</span>
<span class="linenos"> 415</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--push_to_hub&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to push the model to the Hub.&quot;</span><span class="p">)</span>
<span class="linenos"> 416</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hub_token&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The token to use to push to the Model Hub.&quot;</span><span class="p">)</span>
<span class="linenos"> 417</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 418</span>        <span class="s2">&quot;--prediction_type&quot;</span><span class="p">,</span>
<span class="linenos"> 419</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 420</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 421</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The prediction_type that shall be used for training. Choose between &#39;epsilon&#39; or &#39;v_prediction&#39; or leave `None`. If left to `None` the default prediction type of the scheduler: `noise_scheduler.config.prediction_type` is chosen.&quot;</span><span class="p">,</span>
<span class="linenos"> 422</span>    <span class="p">)</span>
<span class="linenos"> 423</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 424</span>        <span class="s2">&quot;--hub_model_id&quot;</span><span class="p">,</span>
<span class="linenos"> 425</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 426</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 427</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The name of the repository to keep in sync with the local `output_dir`.&quot;</span><span class="p">,</span>
<span class="linenos"> 428</span>    <span class="p">)</span>
<span class="linenos"> 429</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 430</span>        <span class="s2">&quot;--logging_dir&quot;</span><span class="p">,</span>
<span class="linenos"> 431</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 432</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span>
<span class="linenos"> 433</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 434</span>            <span class="s2">&quot;[TensorBoard](https://www.tensorflow.org/tensorboard) log directory. Will default to&quot;</span>
<span class="linenos"> 435</span>            <span class="s2">&quot; *output_dir/runs/**CURRENT_DATETIME_HOSTNAME***.&quot;</span>
<span class="linenos"> 436</span>        <span class="p">),</span>
<span class="linenos"> 437</span>    <span class="p">)</span>
<span class="linenos"> 438</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 439</span>        <span class="s2">&quot;--mixed_precision&quot;</span><span class="p">,</span>
<span class="linenos"> 440</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 441</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 442</span>        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">],</span>
<span class="linenos"> 443</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 444</span>            <span class="s2">&quot;Whether to use mixed precision. Choose between fp16 and bf16 (bfloat16). Bf16 requires PyTorch &gt;=&quot;</span>
<span class="linenos"> 445</span>            <span class="s2">&quot; 1.10.and an Nvidia Ampere GPU.  Default to the value of accelerate config of the current system or the&quot;</span>
<span class="linenos"> 446</span>            <span class="s2">&quot; flag passed with the `accelerate.launch` command. Use this argument to override the accelerate config.&quot;</span>
<span class="linenos"> 447</span>        <span class="p">),</span>
<span class="linenos"> 448</span>    <span class="p">)</span>
<span class="linenos"> 449</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 450</span>        <span class="s2">&quot;--report_to&quot;</span><span class="p">,</span>
<span class="linenos"> 451</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 452</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">,</span>
<span class="linenos"> 453</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 454</span>            <span class="s1">&#39;The integration to report the results and logs to. Supported platforms are `&quot;tensorboard&quot;`&#39;</span>
<span class="linenos"> 455</span>            <span class="s1">&#39; (default), `&quot;wandb&quot;` and `&quot;comet_ml&quot;`. Use `&quot;all&quot;` to report to all integrations.&#39;</span>
<span class="linenos"> 456</span>        <span class="p">),</span>
<span class="linenos"> 457</span>    <span class="p">)</span>
<span class="linenos"> 458</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--local_rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For distributed training: local_rank&quot;</span><span class="p">)</span>
<span class="linenos"> 459</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 460</span>        <span class="s2">&quot;--checkpointing_steps&quot;</span><span class="p">,</span>
<span class="linenos"> 461</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 462</span>        <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<span class="linenos"> 463</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 464</span>            <span class="s2">&quot;Save a checkpoint of the training state every X updates. These checkpoints are only suitable for resuming&quot;</span>
<span class="linenos"> 465</span>            <span class="s2">&quot; training using `--resume_from_checkpoint`.&quot;</span>
<span class="linenos"> 466</span>        <span class="p">),</span>
<span class="linenos"> 467</span>    <span class="p">)</span>
<span class="linenos"> 468</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 469</span>        <span class="s2">&quot;--checkpoints_total_limit&quot;</span><span class="p">,</span>
<span class="linenos"> 470</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 471</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 472</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Max number of checkpoints to store.&quot;</span><span class="p">),</span>
<span class="linenos"> 473</span>    <span class="p">)</span>
<span class="linenos"> 474</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 475</span>        <span class="s2">&quot;--resume_from_checkpoint&quot;</span><span class="p">,</span>
<span class="linenos"> 476</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 477</span>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 478</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 479</span>            <span class="s2">&quot;Whether training should be resumed from a previous checkpoint. Use a path saved by&quot;</span>
<span class="linenos"> 480</span>            <span class="s1">&#39; `--checkpointing_steps`, or `&quot;latest&quot;` to automatically select the last available checkpoint.&#39;</span>
<span class="linenos"> 481</span>        <span class="p">),</span>
<span class="linenos"> 482</span>    <span class="p">)</span>
<span class="linenos"> 483</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 484</span>        <span class="s2">&quot;--enable_xformers_memory_efficient_attention&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to use xformers.&quot;</span>
<span class="linenos"> 485</span>    <span class="p">)</span>
<span class="linenos"> 486</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--noise_offset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The scale of noise offset.&quot;</span><span class="p">)</span>
<span class="linenos"> 487</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 488</span>        <span class="s2">&quot;--validation_epochs&quot;</span><span class="p">,</span>
<span class="linenos"> 489</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 490</span>        <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="linenos"> 491</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run validation every X epochs.&quot;</span><span class="p">,</span>
<span class="linenos"> 492</span>    <span class="p">)</span>
<span class="linenos"> 493</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 494</span>        <span class="s2">&quot;--tracker_project_name&quot;</span><span class="p">,</span>
<span class="linenos"> 495</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 496</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;text2image-fine-tune&quot;</span><span class="p">,</span>
<span class="linenos"> 497</span>        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 498</span>            <span class="s2">&quot;The `project_name` argument passed to Accelerator.init_trackers for&quot;</span>
<span class="linenos"> 499</span>            <span class="s2">&quot; more information see https://huggingface.co/docs/accelerate/v0.17.0/en/package_reference/accelerator#accelerate.Accelerator&quot;</span>
<span class="linenos"> 500</span>        <span class="p">),</span>
<span class="linenos"> 501</span>    <span class="p">)</span>
<span class="linenos"> 502</span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="linenos"> 503</span>        <span class="s2">&quot;--image_interpolation_mode&quot;</span><span class="p">,</span>
<span class="linenos"> 504</span>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 505</span>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lanczos&quot;</span><span class="p">,</span>
<span class="linenos"> 506</span>        <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
<span class="linenos"> 507</span>            <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">InterpolationMode</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
<span class="linenos"> 508</span>        <span class="p">],</span>
<span class="linenos"> 509</span>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The image interpolation method to use for resizing images.&quot;</span><span class="p">,</span>
<span class="linenos"> 510</span>    <span class="p">)</span>
<span class="linenos"> 511</span>
<span class="linenos"> 512</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="linenos"> 513</span>    <span class="n">env_local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos"> 514</span>    <span class="k">if</span> <span class="n">env_local_rank</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">env_local_rank</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">:</span>
<span class="linenos"> 515</span>        <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">=</span> <span class="n">env_local_rank</span>
<span class="linenos"> 516</span>
<span class="linenos"> 517</span>    <span class="c1"># Sanity checks</span>
<span class="linenos"> 518</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 519</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need either a dataset name or a training folder.&quot;</span><span class="p">)</span>
<span class="linenos"> 520</span>
<span class="linenos"> 521</span>    <span class="c1"># default to using the same revision for the non-ema model if not specified</span>
<span class="linenos"> 522</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">non_ema_revision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 523</span>        <span class="n">args</span><span class="o">.</span><span class="n">non_ema_revision</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">revision</span>
<span class="linenos"> 524</span>
<span class="linenos"> 525</span>    <span class="k">return</span> <span class="n">args</span>
<span class="linenos"> 526</span>
<span class="linenos"> 527</span>
<span class="linenos"> 528</span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 529</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
<span class="linenos"> 530</span>
<span class="linenos"> 531</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">report_to</span> <span class="o">==</span> <span class="s2">&quot;wandb&quot;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">hub_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 532</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 533</span>            <span class="s2">&quot;You cannot use both --report_to=wandb and --hub_token due to a security risk of exposing your token.&quot;</span>
<span class="linenos"> 534</span>            <span class="s2">&quot; Please use `hf auth login` to authenticate with the Hub.&quot;</span>
<span class="linenos"> 535</span>        <span class="p">)</span>
<span class="linenos"> 536</span>
<span class="linenos"> 537</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">non_ema_revision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 538</span>        <span class="n">deprecate</span><span class="p">(</span>
<span class="linenos"> 539</span>            <span class="s2">&quot;non_ema_revision!=None&quot;</span><span class="p">,</span>
<span class="linenos"> 540</span>            <span class="s2">&quot;0.15.0&quot;</span><span class="p">,</span>
<span class="linenos"> 541</span>            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
<span class="linenos"> 542</span>                <span class="s2">&quot;Downloading &#39;non_ema&#39; weights from revision branches of the Hub is deprecated. Please make sure to&quot;</span>
<span class="linenos"> 543</span>                <span class="s2">&quot; use `--variant=non_ema` instead.&quot;</span>
<span class="linenos"> 544</span>            <span class="p">),</span>
<span class="linenos"> 545</span>        <span class="p">)</span>
<span class="linenos"> 546</span>    <span class="n">logging_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_dir</span><span class="p">)</span>
<span class="linenos"> 547</span>
<span class="linenos"> 548</span>    <span class="n">accelerator_project_config</span> <span class="o">=</span> <span class="n">ProjectConfiguration</span><span class="p">(</span><span class="n">project_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">)</span>
<span class="linenos"> 549</span>
<span class="linenos"> 550</span>    <span class="n">accelerator</span> <span class="o">=</span> <span class="n">Accelerator</span><span class="p">(</span>
<span class="linenos"> 551</span>        <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="p">,</span>
<span class="linenos"> 552</span>        <span class="n">mixed_precision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">,</span>
<span class="linenos"> 553</span>        <span class="n">log_with</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_to</span><span class="p">,</span>
<span class="linenos"> 554</span>        <span class="n">project_config</span><span class="o">=</span><span class="n">accelerator_project_config</span><span class="p">,</span>
<span class="linenos"> 555</span>    <span class="p">)</span>
<span class="linenos"> 556</span>
<span class="linenos"> 557</span>    <span class="c1"># Disable AMP for MPS.</span>
<span class="linenos"> 558</span>    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<span class="linenos"> 559</span>        <span class="n">accelerator</span><span class="o">.</span><span class="n">native_amp</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 560</span>
<span class="linenos"> 561</span>    <span class="c1"># Make one log on every process with the configuration for debugging.</span>
<span class="linenos"> 562</span>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
<span class="linenos"> 563</span>        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos"> 564</span>        <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %H:%M:%S&quot;</span><span class="p">,</span>
<span class="linenos"> 565</span>        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
<span class="linenos"> 566</span>    <span class="p">)</span>
<span class="linenos"> 567</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">main_process_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 568</span>    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_local_main_process</span><span class="p">:</span>
<span class="linenos"> 569</span>        <span class="n">datasets</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_warning</span><span class="p">()</span>
<span class="linenos"> 570</span>        <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_warning</span><span class="p">()</span>
<span class="linenos"> 571</span>        <span class="n">diffusers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_info</span><span class="p">()</span>
<span class="linenos"> 572</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 573</span>        <span class="n">datasets</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span>
<span class="linenos"> 574</span>        <span class="n">transformers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span>
<span class="linenos"> 575</span>        <span class="n">diffusers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span>
<span class="linenos"> 576</span>
<span class="linenos"> 577</span>    <span class="c1"># If passed along, set the training seed now.</span>
<span class="linenos"> 578</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 579</span>        <span class="n">set_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos"> 580</span>
<span class="linenos"> 581</span>    <span class="c1"># Handle the repository creation</span>
<span class="linenos"> 582</span>    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos"> 583</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 584</span>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 585</span>
<span class="linenos"> 586</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">:</span>
<span class="linenos"> 587</span>            <span class="n">repo_id</span> <span class="o">=</span> <span class="n">create_repo</span><span class="p">(</span>
<span class="linenos"> 588</span>                <span class="n">repo_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hub_model_id</span> <span class="ow">or</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hub_token</span>
<span class="linenos"> 589</span>            <span class="p">)</span><span class="o">.</span><span class="n">repo_id</span>
<span class="linenos"> 590</span>
<span class="linenos"> 591</span>    <span class="c1"># Load scheduler, tokenizer and models.</span>
<span class="linenos"> 592</span>    <span class="n">noise_scheduler</span> <span class="o">=</span> <span class="n">DDPMScheduler</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;scheduler&quot;</span><span class="p">)</span>
<span class="linenos"> 593</span>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">CLIPTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 594</span>        <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span>
<span class="linenos"> 595</span>    <span class="p">)</span>
<span class="linenos"> 596</span>
<span class="linenos"> 597</span>    <span class="k">def</span><span class="w"> </span><span class="nf">deepspeed_zero_init_disabled_context_manager</span><span class="p">():</span>
<span class="linenos"> 598</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 599</span><span class="sd">        returns either a context list that includes one that will disable zero.Init or an empty context list</span>
<span class="linenos"> 600</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 601</span>        <span class="n">deepspeed_plugin</span> <span class="o">=</span> <span class="n">AcceleratorState</span><span class="p">()</span><span class="o">.</span><span class="n">deepspeed_plugin</span> <span class="k">if</span> <span class="n">accelerate</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 602</span>        <span class="k">if</span> <span class="n">deepspeed_plugin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 603</span>            <span class="k">return</span> <span class="p">[]</span>
<span class="linenos"> 604</span>
<span class="linenos"> 605</span>        <span class="k">return</span> <span class="p">[</span><span class="n">deepspeed_plugin</span><span class="o">.</span><span class="n">zero3_init_context_manager</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="linenos"> 606</span>
<span class="linenos"> 607</span>    <span class="c1"># Currently Accelerate doesn&#39;t know how to handle multiple models under Deepspeed ZeRO stage 3.</span>
<span class="linenos"> 608</span>    <span class="c1"># For this to work properly all models must be run through `accelerate.prepare`. But accelerate</span>
<span class="linenos"> 609</span>    <span class="c1"># will try to assign the same optimizer with the same weights to all models during</span>
<span class="linenos"> 610</span>    <span class="c1"># `deepspeed.initialize`, which of course doesn&#39;t work.</span>
<span class="linenos"> 611</span>    <span class="c1">#</span>
<span class="linenos"> 612</span>    <span class="c1"># For now the following workaround will partially support Deepspeed ZeRO-3, by excluding the 2</span>
<span class="linenos"> 613</span>    <span class="c1"># frozen models from being partitioned during `zero.Init` which gets called during</span>
<span class="linenos"> 614</span>    <span class="c1"># `from_pretrained` So CLIPTextModel and AutoencoderKL will not enjoy the parameter sharding</span>
<span class="linenos"> 615</span>    <span class="c1"># across multiple gpus and only UNet2DConditionModel will get ZeRO sharded.</span>
<span class="linenos"> 616</span>    <span class="k">with</span> <span class="n">ContextManagers</span><span class="p">(</span><span class="n">deepspeed_zero_init_disabled_context_manager</span><span class="p">()):</span>
<span class="linenos"> 617</span>        <span class="n">text_encoder</span> <span class="o">=</span> <span class="n">CLIPTextModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 618</span>            <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;text_encoder&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">variant</span>
<span class="linenos"> 619</span>        <span class="p">)</span>
<span class="linenos"> 620</span>        <span class="n">vae</span> <span class="o">=</span> <span class="n">AutoencoderKL</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 621</span>            <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;vae&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">variant</span>
<span class="linenos"> 622</span>        <span class="p">)</span>
<span class="linenos"> 623</span>
<span class="linenos"> 624</span>    <span class="n">unet</span> <span class="o">=</span> <span class="n">UNet2DConditionModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 625</span>        <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;unet&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">non_ema_revision</span>
<span class="linenos"> 626</span>    <span class="p">)</span>
<span class="linenos"> 627</span>
<span class="linenos"> 628</span>    <span class="c1"># Freeze vae and text_encoder and set unet to trainable</span>
<span class="linenos"> 629</span>    <span class="n">vae</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 630</span>    <span class="n">text_encoder</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 631</span>    <span class="n">unet</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos"> 632</span>
<span class="linenos"> 633</span>    <span class="c1"># Create EMA for the unet.</span>
<span class="linenos"> 634</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos"> 635</span>        <span class="n">ema_unet</span> <span class="o">=</span> <span class="n">UNet2DConditionModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 636</span>            <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;unet&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">variant</span>
<span class="linenos"> 637</span>        <span class="p">)</span>
<span class="linenos"> 638</span>        <span class="n">ema_unet</span> <span class="o">=</span> <span class="n">EMAModel</span><span class="p">(</span>
<span class="linenos"> 639</span>            <span class="n">ema_unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<span class="linenos"> 640</span>            <span class="n">model_cls</span><span class="o">=</span><span class="n">UNet2DConditionModel</span><span class="p">,</span>
<span class="linenos"> 641</span>            <span class="n">model_config</span><span class="o">=</span><span class="n">ema_unet</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
<span class="linenos"> 642</span>            <span class="n">foreach</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">foreach_ema</span><span class="p">,</span>
<span class="linenos"> 643</span>        <span class="p">)</span>
<span class="linenos"> 644</span>
<span class="linenos"> 645</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">:</span>
<span class="linenos"> 646</span>        <span class="k">if</span> <span class="n">is_xformers_available</span><span class="p">():</span>
<span class="linenos"> 647</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">xformers</span>
<span class="linenos"> 648</span>
<span class="linenos"> 649</span>            <span class="n">xformers_version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xformers</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="linenos"> 650</span>            <span class="k">if</span> <span class="n">xformers_version</span> <span class="o">==</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;0.0.16&quot;</span><span class="p">):</span>
<span class="linenos"> 651</span>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos"> 652</span>                    <span class="s2">&quot;xFormers 0.0.16 cannot be used for training in some GPUs. If you observe problems during training, please update xFormers to at least 0.0.17. See https://huggingface.co/docs/diffusers/main/en/optimization/xformers for more details.&quot;</span>
<span class="linenos"> 653</span>                <span class="p">)</span>
<span class="linenos"> 654</span>            <span class="n">unet</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">()</span>
<span class="linenos"> 655</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 656</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xformers is not available. Make sure it is installed correctly&quot;</span><span class="p">)</span>
<span class="linenos"> 657</span>
<span class="linenos"> 658</span>    <span class="c1"># `accelerate` 0.16.0 will have better support for customized saving</span>
<span class="linenos"> 659</span>    <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">accelerate</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;0.16.0&quot;</span><span class="p">):</span>
<span class="linenos"> 660</span>        <span class="c1"># create custom saving &amp; loading hooks so that `accelerator.save_state(...)` serializes in a nice format</span>
<span class="linenos"> 661</span>        <span class="k">def</span><span class="w"> </span><span class="nf">save_model_hook</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="linenos"> 662</span>            <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos"> 663</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos"> 664</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unet_ema&quot;</span><span class="p">))</span>
<span class="linenos"> 665</span>
<span class="linenos"> 666</span>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
<span class="linenos"> 667</span>                    <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;unet&quot;</span><span class="p">))</span>
<span class="linenos"> 668</span>
<span class="linenos"> 669</span>                    <span class="c1"># make sure to pop weight so that corresponding model is not saved again</span>
<span class="linenos"> 670</span>                    <span class="n">weights</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 671</span>
<span class="linenos"> 672</span>        <span class="k">def</span><span class="w"> </span><span class="nf">load_model_hook</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">):</span>
<span class="linenos"> 673</span>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos"> 674</span>                <span class="n">load_model</span> <span class="o">=</span> <span class="n">EMAModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos"> 675</span>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&quot;unet_ema&quot;</span><span class="p">),</span> <span class="n">UNet2DConditionModel</span><span class="p">,</span> <span class="n">foreach</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">foreach_ema</span>
<span class="linenos"> 676</span>                <span class="p">)</span>
<span class="linenos"> 677</span>                <span class="n">ema_unet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">load_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<span class="linenos"> 678</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">offload_ema</span><span class="p">:</span>
<span class="linenos"> 679</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
<span class="linenos"> 680</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 681</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos"> 682</span>                <span class="k">del</span> <span class="n">load_model</span>
<span class="linenos"> 683</span>
<span class="linenos"> 684</span>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
<span class="linenos"> 685</span>                <span class="c1"># pop models so that they are not loaded again</span>
<span class="linenos"> 686</span>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 687</span>
<span class="linenos"> 688</span>                <span class="c1"># load diffusers style into model</span>
<span class="linenos"> 689</span>                <span class="n">load_model</span> <span class="o">=</span> <span class="n">UNet2DConditionModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;unet&quot;</span><span class="p">)</span>
<span class="linenos"> 690</span>                <span class="n">model</span><span class="o">.</span><span class="n">register_to_config</span><span class="p">(</span><span class="o">**</span><span class="n">load_model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="linenos"> 691</span>
<span class="linenos"> 692</span>                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">load_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<span class="linenos"> 693</span>                <span class="k">del</span> <span class="n">load_model</span>
<span class="linenos"> 694</span>
<span class="linenos"> 695</span>        <span class="n">accelerator</span><span class="o">.</span><span class="n">register_save_state_pre_hook</span><span class="p">(</span><span class="n">save_model_hook</span><span class="p">)</span>
<span class="linenos"> 696</span>        <span class="n">accelerator</span><span class="o">.</span><span class="n">register_load_state_pre_hook</span><span class="p">(</span><span class="n">load_model_hook</span><span class="p">)</span>
<span class="linenos"> 697</span>
<span class="linenos"> 698</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_checkpointing</span><span class="p">:</span>
<span class="linenos"> 699</span>        <span class="n">unet</span><span class="o">.</span><span class="n">enable_gradient_checkpointing</span><span class="p">()</span>
<span class="linenos"> 700</span>
<span class="linenos"> 701</span>    <span class="c1"># Enable TF32 for faster training on Ampere GPUs,</span>
<span class="linenos"> 702</span>    <span class="c1"># cf https://pytorch.org/docs/stable/notes/cuda.html#tensorfloat-32-tf32-on-ampere-devices</span>
<span class="linenos"> 703</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">allow_tf32</span><span class="p">:</span>
<span class="linenos"> 704</span>        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 705</span>
<span class="linenos"> 706</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">scale_lr</span><span class="p">:</span>
<span class="linenos"> 707</span>        <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 708</span>            <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span>
<span class="linenos"> 709</span>        <span class="p">)</span>
<span class="linenos"> 710</span>
<span class="linenos"> 711</span>    <span class="c1"># Initialize the optimizer</span>
<span class="linenos"> 712</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_8bit_adam</span><span class="p">:</span>
<span class="linenos"> 713</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 714</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">bitsandbytes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bnb</span>
<span class="linenos"> 715</span>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="linenos"> 716</span>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
<span class="linenos"> 717</span>                <span class="s2">&quot;Please install bitsandbytes to use 8-bit Adam. You can do so by running `pip install bitsandbytes`&quot;</span>
<span class="linenos"> 718</span>            <span class="p">)</span>
<span class="linenos"> 719</span>
<span class="linenos"> 720</span>        <span class="n">optimizer_cls</span> <span class="o">=</span> <span class="n">bnb</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW8bit</span>
<span class="linenos"> 721</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 722</span>        <span class="n">optimizer_cls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span>
<span class="linenos"> 723</span>
<span class="linenos"> 724</span>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_cls</span><span class="p">(</span>
<span class="linenos"> 725</span>        <span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<span class="linenos"> 726</span>        <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
<span class="linenos"> 727</span>        <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">adam_beta1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">adam_beta2</span><span class="p">),</span>
<span class="linenos"> 728</span>        <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">adam_weight_decay</span><span class="p">,</span>
<span class="linenos"> 729</span>        <span class="n">eps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">adam_epsilon</span><span class="p">,</span>
<span class="linenos"> 730</span>    <span class="p">)</span>
<span class="linenos"> 731</span>
<span class="linenos"> 732</span>    <span class="c1"># Get the datasets: you can either provide your own training and evaluation files (see below)</span>
<span class="linenos"> 733</span>    <span class="c1"># or specify a Dataset from the hub (the dataset will be downloaded automatically from the datasets Hub).</span>
<span class="linenos"> 734</span>
<span class="linenos"> 735</span>    <span class="c1"># In distributed training, the load_dataset function guarantees that only one local process can concurrently</span>
<span class="linenos"> 736</span>    <span class="c1"># download the dataset.</span>
<span class="linenos"> 737</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 738</span>        <span class="c1"># Downloading and loading a dataset from the hub.</span>
<span class="linenos"> 739</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos"> 740</span>            <span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
<span class="linenos"> 741</span>            <span class="n">args</span><span class="o">.</span><span class="n">dataset_config_name</span><span class="p">,</span>
<span class="linenos"> 742</span>            <span class="n">cache_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos"> 743</span>            <span class="n">data_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_data_dir</span><span class="p">,</span>
<span class="linenos"> 744</span>        <span class="p">)</span>
<span class="linenos"> 745</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 746</span>        <span class="n">data_files</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 747</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 748</span>            <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_data_dir</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">)</span>
<span class="linenos"> 749</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
<span class="linenos"> 750</span>            <span class="s2">&quot;imagefolder&quot;</span><span class="p">,</span>
<span class="linenos"> 751</span>            <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
<span class="linenos"> 752</span>            <span class="n">cache_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
<span class="linenos"> 753</span>        <span class="p">)</span>
<span class="linenos"> 754</span>        <span class="c1"># See more about loading custom images at</span>
<span class="linenos"> 755</span>        <span class="c1"># https://huggingface.co/docs/datasets/v2.4.0/en/image_load#imagefolder</span>
<span class="linenos"> 756</span>
<span class="linenos"> 757</span>    <span class="c1"># Preprocessing the datasets.</span>
<span class="linenos"> 758</span>    <span class="c1"># We need to tokenize inputs and targets.</span>
<span class="linenos"> 759</span>    <span class="n">column_names</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">column_names</span>
<span class="linenos"> 760</span>
<span class="linenos"> 761</span>    <span class="c1"># 6. Get the column names for input/target.</span>
<span class="linenos"> 762</span>    <span class="n">dataset_columns</span> <span class="o">=</span> <span class="n">DATASET_NAME_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 763</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">image_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 764</span>        <span class="n">image_column</span> <span class="o">=</span> <span class="n">dataset_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 765</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 766</span>        <span class="n">image_column</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">image_column</span>
<span class="linenos"> 767</span>        <span class="k">if</span> <span class="n">image_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
<span class="linenos"> 768</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 769</span>                <span class="sa">f</span><span class="s2">&quot;--image_column&#39; value &#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">image_column</span><span class="si">}</span><span class="s2">&#39; needs to be one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos"> 770</span>            <span class="p">)</span>
<span class="linenos"> 771</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">caption_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 772</span>        <span class="n">caption_column</span> <span class="o">=</span> <span class="n">dataset_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 773</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 774</span>        <span class="n">caption_column</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">caption_column</span>
<span class="linenos"> 775</span>        <span class="k">if</span> <span class="n">caption_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
<span class="linenos"> 776</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 777</span>                <span class="sa">f</span><span class="s2">&quot;--caption_column&#39; value &#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">caption_column</span><span class="si">}</span><span class="s2">&#39; needs to be one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos"> 778</span>            <span class="p">)</span>
<span class="linenos"> 779</span>
<span class="linenos"> 780</span>    <span class="c1"># Preprocessing the datasets.</span>
<span class="linenos"> 781</span>    <span class="c1"># We need to tokenize input captions and transform the images.</span>
<span class="linenos"> 782</span>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_captions</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 783</span>        <span class="n">captions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 784</span>        <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">[</span><span class="n">caption_column</span><span class="p">]:</span>
<span class="linenos"> 785</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">caption</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 786</span>                <span class="n">captions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
<span class="linenos"> 787</span>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">caption</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
<span class="linenos"> 788</span>                <span class="c1"># take a random caption if there are multiple</span>
<span class="linenos"> 789</span>                <span class="n">captions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="n">caption</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 790</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 791</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 792</span>                    <span class="sa">f</span><span class="s2">&quot;Caption column `</span><span class="si">{</span><span class="n">caption_column</span><span class="si">}</span><span class="s2">` should contain either strings or lists of strings.&quot;</span>
<span class="linenos"> 793</span>                <span class="p">)</span>
<span class="linenos"> 794</span>        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
<span class="linenos"> 795</span>            <span class="n">captions</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
<span class="linenos"> 796</span>        <span class="p">)</span>
<span class="linenos"> 797</span>        <span class="k">return</span> <span class="n">inputs</span><span class="o">.</span><span class="n">input_ids</span>
<span class="linenos"> 798</span>
<span class="linenos"> 799</span>    <span class="c1"># Get the specified interpolation method from the args</span>
<span class="linenos"> 800</span>    <span class="n">interpolation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">InterpolationMode</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">image_interpolation_mode</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 801</span>
<span class="linenos"> 802</span>    <span class="c1"># Raise an error if the interpolation method is invalid</span>
<span class="linenos"> 803</span>    <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 804</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported interpolation mode </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">image_interpolation_mode</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="linenos"> 805</span>
<span class="linenos"> 806</span>    <span class="c1"># Data preprocessing transformations</span>
<span class="linenos"> 807</span>    <span class="n">train_transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
<span class="linenos"> 808</span>        <span class="p">[</span>
<span class="linenos"> 809</span>            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">),</span>  <span class="c1"># Use dynamic interpolation method</span>
<span class="linenos"> 810</span>            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">center_crop</span> <span class="k">else</span> <span class="n">transforms</span><span class="o">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resolution</span><span class="p">),</span>
<span class="linenos"> 811</span>            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">()</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">random_flip</span> <span class="k">else</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
<span class="linenos"> 812</span>            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos"> 813</span>            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]),</span>
<span class="linenos"> 814</span>        <span class="p">]</span>
<span class="linenos"> 815</span>    <span class="p">)</span>
<span class="linenos"> 816</span>
<span class="linenos"> 817</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_train</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
<span class="linenos"> 818</span>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">[</span><span class="n">image_column</span><span class="p">]]</span>
<span class="linenos"> 819</span>        <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_transforms</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
<span class="linenos"> 820</span>        <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenize_captions</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
<span class="linenos"> 821</span>        <span class="k">return</span> <span class="n">examples</span>
<span class="linenos"> 822</span>
<span class="linenos"> 823</span>    <span class="k">with</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">main_process_first</span><span class="p">():</span>
<span class="linenos"> 824</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 825</span>            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">max_train_samples</span><span class="p">))</span>
<span class="linenos"> 826</span>        <span class="c1"># Set the training transforms</span>
<span class="linenos"> 827</span>        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="n">preprocess_train</span><span class="p">)</span>
<span class="linenos"> 828</span>
<span class="linenos"> 829</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
<span class="linenos"> 830</span>        <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
<span class="linenos"> 831</span>        <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">pixel_values</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">contiguous_format</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="linenos"> 832</span>        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
<span class="linenos"> 833</span>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">:</span> <span class="n">pixel_values</span><span class="p">,</span> <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">input_ids</span><span class="p">}</span>
<span class="linenos"> 834</span>
<span class="linenos"> 835</span>    <span class="c1"># DataLoaders creation:</span>
<span class="linenos"> 836</span>    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos"> 837</span>        <span class="n">train_dataset</span><span class="p">,</span>
<span class="linenos"> 838</span>        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 839</span>        <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
<span class="linenos"> 840</span>        <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="p">,</span>
<span class="linenos"> 841</span>        <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
<span class="linenos"> 842</span>    <span class="p">)</span>
<span class="linenos"> 843</span>
<span class="linenos"> 844</span>    <span class="c1"># Scheduler and math around the number of training steps.</span>
<span class="linenos"> 845</span>    <span class="c1"># Check the PR https://github.com/huggingface/diffusers/pull/8312 for detailed explanation.</span>
<span class="linenos"> 846</span>    <span class="n">num_warmup_steps_for_scheduler</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr_warmup_steps</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span>
<span class="linenos"> 847</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 848</span>        <span class="n">len_train_dataloader_after_sharding</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span> <span class="o">/</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span><span class="p">)</span>
<span class="linenos"> 849</span>        <span class="n">num_update_steps_per_epoch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">len_train_dataloader_after_sharding</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="p">)</span>
<span class="linenos"> 850</span>        <span class="n">num_training_steps_for_scheduler</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 851</span>            <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">*</span> <span class="n">num_update_steps_per_epoch</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span>
<span class="linenos"> 852</span>        <span class="p">)</span>
<span class="linenos"> 853</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 854</span>        <span class="n">num_training_steps_for_scheduler</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span>
<span class="linenos"> 855</span>
<span class="linenos"> 856</span>    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">get_scheduler</span><span class="p">(</span>
<span class="linenos"> 857</span>        <span class="n">args</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="p">,</span>
<span class="linenos"> 858</span>        <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
<span class="linenos"> 859</span>        <span class="n">num_warmup_steps</span><span class="o">=</span><span class="n">num_warmup_steps_for_scheduler</span><span class="p">,</span>
<span class="linenos"> 860</span>        <span class="n">num_training_steps</span><span class="o">=</span><span class="n">num_training_steps_for_scheduler</span><span class="p">,</span>
<span class="linenos"> 861</span>    <span class="p">)</span>
<span class="linenos"> 862</span>
<span class="linenos"> 863</span>    <span class="c1"># Prepare everything with our `accelerator`.</span>
<span class="linenos"> 864</span>    <span class="n">unet</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
<span class="linenos"> 865</span>        <span class="n">unet</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">lr_scheduler</span>
<span class="linenos"> 866</span>    <span class="p">)</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos"> 869</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">offload_ema</span><span class="p">:</span>
<span class="linenos"> 870</span>            <span class="n">ema_unet</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
<span class="linenos"> 871</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 872</span>            <span class="n">ema_unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos"> 873</span>
<span class="linenos"> 874</span>    <span class="c1"># For mixed precision training we cast all non-trainable weights (vae, non-lora text_encoder and non-lora unet) to half-precision</span>
<span class="linenos"> 875</span>    <span class="c1"># as these weights are only used for inference, keeping weights in full precision is not required.</span>
<span class="linenos"> 876</span>    <span class="n">weight_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
<span class="linenos"> 877</span>    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">==</span> <span class="s2">&quot;fp16&quot;</span><span class="p">:</span>
<span class="linenos"> 878</span>        <span class="n">weight_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
<span class="linenos"> 879</span>        <span class="n">args</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">mixed_precision</span>
<span class="linenos"> 880</span>    <span class="k">elif</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">==</span> <span class="s2">&quot;bf16&quot;</span><span class="p">:</span>
<span class="linenos"> 881</span>        <span class="n">weight_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span>
<span class="linenos"> 882</span>        <span class="n">args</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">mixed_precision</span>
<span class="linenos"> 883</span>
<span class="linenos"> 884</span>    <span class="c1"># Move text_encode and vae to gpu and cast to weight_dtype</span>
<span class="linenos"> 885</span>    <span class="n">text_encoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weight_dtype</span><span class="p">)</span>
<span class="linenos"> 886</span>    <span class="n">vae</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">weight_dtype</span><span class="p">)</span>
<span class="linenos"> 887</span>
<span class="linenos"> 888</span>    <span class="c1"># We need to recalculate our total training steps as the size of the training dataloader may have changed.</span>
<span class="linenos"> 889</span>    <span class="n">num_update_steps_per_epoch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="p">)</span>
<span class="linenos"> 890</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 891</span>        <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">*</span> <span class="n">num_update_steps_per_epoch</span>
<span class="linenos"> 892</span>        <span class="k">if</span> <span class="n">num_training_steps_for_scheduler</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span><span class="p">:</span>
<span class="linenos"> 893</span>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos"> 894</span>                <span class="sa">f</span><span class="s2">&quot;The length of the &#39;train_dataloader&#39; after &#39;accelerator.prepare&#39; (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2">) does not match &quot;</span>
<span class="linenos"> 895</span>                <span class="sa">f</span><span class="s2">&quot;the expected length (</span><span class="si">{</span><span class="n">len_train_dataloader_after_sharding</span><span class="si">}</span><span class="s2">) when the learning rate scheduler was created. &quot;</span>
<span class="linenos"> 896</span>                <span class="sa">f</span><span class="s2">&quot;This inconsistency may result in the learning rate scheduler not functioning properly.&quot;</span>
<span class="linenos"> 897</span>            <span class="p">)</span>
<span class="linenos"> 898</span>    <span class="c1"># Afterwards we recalculate our number of training epochs</span>
<span class="linenos"> 899</span>    <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">/</span> <span class="n">num_update_steps_per_epoch</span><span class="p">)</span>
<span class="linenos"> 900</span>
<span class="linenos"> 901</span>    <span class="c1"># We need to initialize the trackers we use, and also store our configuration.</span>
<span class="linenos"> 902</span>    <span class="c1"># The trackers initializes automatically on the main process.</span>
<span class="linenos"> 903</span>    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos"> 904</span>        <span class="n">tracker_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
<span class="linenos"> 905</span>        <span class="n">tracker_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;validation_prompts&quot;</span><span class="p">)</span>
<span class="linenos"> 906</span>        <span class="n">accelerator</span><span class="o">.</span><span class="n">init_trackers</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tracker_project_name</span><span class="p">,</span> <span class="n">tracker_config</span><span class="p">)</span>
<span class="linenos"> 907</span>
<span class="linenos"> 908</span>    <span class="c1"># Function for unwrapping if model was compiled with `torch.compile`.</span>
<span class="linenos"> 909</span>    <span class="k">def</span><span class="w"> </span><span class="nf">unwrap_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="linenos"> 910</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="linenos"> 911</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_orig_mod</span> <span class="k">if</span> <span class="n">is_compiled_module</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
<span class="linenos"> 912</span>        <span class="k">return</span> <span class="n">model</span>
<span class="linenos"> 913</span>
<span class="linenos"> 914</span>    <span class="c1"># Train!</span>
<span class="linenos"> 915</span>    <span class="n">total_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="o">*</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">num_processes</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span>
<span class="linenos"> 916</span>
<span class="linenos"> 917</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Running training *****&quot;</span><span class="p">)</span>
<span class="linenos"> 918</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Num examples = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 919</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Num Epochs = </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 920</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Instantaneous batch size per device = </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 921</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total train batch size (w. parallel, distributed &amp; accumulation) = </span><span class="si">{</span><span class="n">total_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 922</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Gradient Accumulation steps = </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 923</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total optimization steps = </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 924</span>    <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 925</span>    <span class="n">first_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 926</span>
<span class="linenos"> 927</span>    <span class="c1"># Potentially load in the weights and states from a previous save</span>
<span class="linenos"> 928</span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span><span class="p">:</span>
<span class="linenos"> 929</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span> <span class="o">!=</span> <span class="s2">&quot;latest&quot;</span><span class="p">:</span>
<span class="linenos"> 930</span>            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span><span class="p">)</span>
<span class="linenos"> 931</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 932</span>            <span class="c1"># Get the most recent checkpoint</span>
<span class="linenos"> 933</span>            <span class="n">dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="linenos"> 934</span>            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">)]</span>
<span class="linenos"> 935</span>            <span class="n">dirs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dirs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="linenos"> 936</span>            <span class="n">path</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 937</span>
<span class="linenos"> 938</span>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 939</span>            <span class="n">accelerator</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
<span class="linenos"> 940</span>                <span class="sa">f</span><span class="s2">&quot;Checkpoint &#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span><span class="si">}</span><span class="s2">&#39; does not exist. Starting a new training run.&quot;</span>
<span class="linenos"> 941</span>            <span class="p">)</span>
<span class="linenos"> 942</span>            <span class="n">args</span><span class="o">.</span><span class="n">resume_from_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 943</span>            <span class="n">initial_global_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 944</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 945</span>            <span class="n">accelerator</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming from checkpoint </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 946</span>            <span class="n">accelerator</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
<span class="linenos"> 947</span>            <span class="n">global_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos"> 948</span>
<span class="linenos"> 949</span>            <span class="n">initial_global_step</span> <span class="o">=</span> <span class="n">global_step</span>
<span class="linenos"> 950</span>            <span class="n">first_epoch</span> <span class="o">=</span> <span class="n">global_step</span> <span class="o">//</span> <span class="n">num_update_steps_per_epoch</span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 953</span>        <span class="n">initial_global_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 954</span>
<span class="linenos"> 955</span>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
<span class="linenos"> 956</span>        <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span><span class="p">),</span>
<span class="linenos"> 957</span>        <span class="n">initial</span><span class="o">=</span><span class="n">initial_global_step</span><span class="p">,</span>
<span class="linenos"> 958</span>        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Steps&quot;</span><span class="p">,</span>
<span class="linenos"> 959</span>        <span class="c1"># Only show the progress bar once on each machine.</span>
<span class="linenos"> 960</span>        <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_local_main_process</span><span class="p">,</span>
<span class="linenos"> 961</span>    <span class="p">)</span>
<span class="linenos"> 962</span>
<span class="linenos"> 963</span>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_epoch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">):</span>
<span class="linenos"> 964</span>        <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 965</span>        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
<span class="linenos"> 966</span>            <span class="k">with</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">unet</span><span class="p">):</span>
<span class="linenos"> 967</span>                <span class="c1"># Convert images to latent space</span>
<span class="linenos"> 968</span>                <span class="n">latents</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">weight_dtype</span><span class="p">))</span><span class="o">.</span><span class="n">latent_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="linenos"> 969</span>                <span class="n">latents</span> <span class="o">=</span> <span class="n">latents</span> <span class="o">*</span> <span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
<span class="linenos"> 970</span>
<span class="linenos"> 971</span>                <span class="c1"># Sample noise that we&#39;ll add to the latents</span>
<span class="linenos"> 972</span>                <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>
<span class="linenos"> 973</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">noise_offset</span><span class="p">:</span>
<span class="linenos"> 974</span>                    <span class="c1"># https://www.crosslabs.org//blog/diffusion-with-offset-noise</span>
<span class="linenos"> 975</span>                    <span class="n">noise</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">noise_offset</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span>
<span class="linenos"> 976</span>                        <span class="p">(</span><span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">device</span>
<span class="linenos"> 977</span>                    <span class="p">)</span>
<span class="linenos"> 978</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">input_perturbation</span><span class="p">:</span>
<span class="linenos"> 979</span>                    <span class="n">new_noise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">input_perturbation</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<span class="linenos"> 980</span>                <span class="n">bsz</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 981</span>                <span class="c1"># Sample a random timestep for each image</span>
<span class="linenos"> 982</span>                <span class="n">timesteps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_train_timesteps</span><span class="p">,</span> <span class="p">(</span><span class="n">bsz</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos"> 983</span>                <span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<span class="linenos"> 984</span>
<span class="linenos"> 985</span>                <span class="c1"># Add noise to the latents according to the noise magnitude at each timestep</span>
<span class="linenos"> 986</span>                <span class="c1"># (this is the forward diffusion process)</span>
<span class="linenos"> 987</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">input_perturbation</span><span class="p">:</span>
<span class="linenos"> 988</span>                    <span class="n">noisy_latents</span> <span class="o">=</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">new_noise</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="linenos"> 989</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 990</span>                    <span class="n">noisy_latents</span> <span class="o">=</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="linenos"> 991</span>
<span class="linenos"> 992</span>                <span class="c1"># Get the text embedding for conditioning</span>
<span class="linenos"> 993</span>                <span class="n">encoder_hidden_states</span> <span class="o">=</span> <span class="n">text_encoder</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 994</span>
<span class="linenos"> 995</span>                <span class="c1"># Get the target for loss depending on the prediction type</span>
<span class="linenos"> 996</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prediction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 997</span>                    <span class="c1"># set prediction_type of scheduler if defined</span>
<span class="linenos"> 998</span>                    <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">register_to_config</span><span class="p">(</span><span class="n">prediction_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">)</span>
<span class="linenos"> 999</span>
<span class="linenos">1000</span>                <span class="k">if</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span>
<span class="linenos">1001</span>                    <span class="n">target</span> <span class="o">=</span> <span class="n">noise</span>
<span class="linenos">1002</span>                <span class="k">elif</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;v_prediction&quot;</span><span class="p">:</span>
<span class="linenos">1003</span>                    <span class="n">target</span> <span class="o">=</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">get_velocity</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="linenos">1004</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1005</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prediction type </span><span class="si">{</span><span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">1006</span>
<span class="linenos">1007</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dream_training</span><span class="p">:</span>
<span class="linenos">1008</span>                    <span class="n">noisy_latents</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">compute_dream_and_update_latents</span><span class="p">(</span>
<span class="linenos">1009</span>                        <span class="n">unet</span><span class="p">,</span>
<span class="linenos">1010</span>                        <span class="n">noise_scheduler</span><span class="p">,</span>
<span class="linenos">1011</span>                        <span class="n">timesteps</span><span class="p">,</span>
<span class="linenos">1012</span>                        <span class="n">noise</span><span class="p">,</span>
<span class="linenos">1013</span>                        <span class="n">noisy_latents</span><span class="p">,</span>
<span class="linenos">1014</span>                        <span class="n">target</span><span class="p">,</span>
<span class="linenos">1015</span>                        <span class="n">encoder_hidden_states</span><span class="p">,</span>
<span class="linenos">1016</span>                        <span class="n">args</span><span class="o">.</span><span class="n">dream_detail_preservation</span><span class="p">,</span>
<span class="linenos">1017</span>                    <span class="p">)</span>
<span class="linenos">1018</span>
<span class="linenos">1019</span>                <span class="c1"># Predict the noise residual and compute loss</span>
<span class="linenos">1020</span>                <span class="n">model_pred</span> <span class="o">=</span> <span class="n">unet</span><span class="p">(</span><span class="n">noisy_latents</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1021</span>
<span class="linenos">1022</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">snr_gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1023</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">model_pred</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">target</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
<span class="linenos">1024</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1025</span>                    <span class="c1"># Compute loss-weights as per Section 3.4 of https://huggingface.co/papers/2303.09556.</span>
<span class="linenos">1026</span>                    <span class="c1"># Since we predict the noise instead of x_0, the original formulation is slightly changed.</span>
<span class="linenos">1027</span>                    <span class="c1"># This is discussed in Section 4.2 of the same paper.</span>
<span class="linenos">1028</span>                    <span class="n">snr</span> <span class="o">=</span> <span class="n">compute_snr</span><span class="p">(</span><span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="linenos">1029</span>                    <span class="n">mse_loss_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">snr</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">snr_gamma</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
<span class="linenos">1030</span>                        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<span class="linenos">1031</span>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1032</span>                    <span class="k">if</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span>
<span class="linenos">1033</span>                        <span class="n">mse_loss_weights</span> <span class="o">=</span> <span class="n">mse_loss_weights</span> <span class="o">/</span> <span class="n">snr</span>
<span class="linenos">1034</span>                    <span class="k">elif</span> <span class="n">noise_scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;v_prediction&quot;</span><span class="p">:</span>
<span class="linenos">1035</span>                        <span class="n">mse_loss_weights</span> <span class="o">=</span> <span class="n">mse_loss_weights</span> <span class="o">/</span> <span class="p">(</span><span class="n">snr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">1036</span>
<span class="linenos">1037</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">model_pred</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">target</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="linenos">1038</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">shape</span><span class="p">))))</span> <span class="o">*</span> <span class="n">mse_loss_weights</span>
<span class="linenos">1039</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="linenos">1040</span>
<span class="linenos">1041</span>                <span class="c1"># Gather the losses across all processes for logging (if we use distributed training).</span>
<span class="linenos">1042</span>                <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="linenos">1043</span>                <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">avg_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span>
<span class="linenos">1044</span>
<span class="linenos">1045</span>                <span class="c1"># Backpropagate</span>
<span class="linenos">1046</span>                <span class="n">accelerator</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="linenos">1047</span>                <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">sync_gradients</span><span class="p">:</span>
<span class="linenos">1048</span>                    <span class="n">accelerator</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>
<span class="linenos">1049</span>                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="linenos">1050</span>                <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="linenos">1051</span>                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="linenos">1052</span>
<span class="linenos">1053</span>            <span class="c1"># Checks if the accelerator has performed an optimization step behind the scenes</span>
<span class="linenos">1054</span>            <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">sync_gradients</span><span class="p">:</span>
<span class="linenos">1055</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos">1056</span>                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">offload_ema</span><span class="p">:</span>
<span class="linenos">1057</span>                        <span class="n">ema_unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1058</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">1059</span>                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">offload_ema</span><span class="p">:</span>
<span class="linenos">1060</span>                        <span class="n">ema_unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1061</span>                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">1062</span>                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">1063</span>                <span class="n">accelerator</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>
<span class="linenos">1064</span>                <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">1065</span>
<span class="linenos">1066</span>                <span class="k">if</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpointing_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1067</span>                    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos">1068</span>                        <span class="c1"># _before_ saving state, check if this save would set us over the `checkpoints_total_limit`</span>
<span class="linenos">1069</span>                        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoints_total_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1070</span>                            <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="linenos">1071</span>                            <span class="n">checkpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">checkpoints</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">)]</span>
<span class="linenos">1072</span>                            <span class="n">checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="linenos">1073</span>
<span class="linenos">1074</span>                            <span class="c1"># before we save the new checkpoint, we need to have at _most_ `checkpoints_total_limit - 1` checkpoints</span>
<span class="linenos">1075</span>                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoints_total_limit</span><span class="p">:</span>
<span class="linenos">1076</span>                                <span class="n">num_to_remove</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span> <span class="o">-</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoints_total_limit</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1077</span>                                <span class="n">removing_checkpoints</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_to_remove</span><span class="p">]</span>
<span class="linenos">1078</span>
<span class="linenos">1079</span>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="linenos">1080</span>                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span><span class="si">}</span><span class="s2"> checkpoints already exist, removing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">removing_checkpoints</span><span class="p">)</span><span class="si">}</span><span class="s2"> checkpoints&quot;</span>
<span class="linenos">1081</span>                                <span class="p">)</span>
<span class="linenos">1082</span>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing checkpoints: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">removing_checkpoints</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">1083</span>
<span class="linenos">1084</span>                                <span class="k">for</span> <span class="n">removing_checkpoint</span> <span class="ow">in</span> <span class="n">removing_checkpoints</span><span class="p">:</span>
<span class="linenos">1085</span>                                    <span class="n">removing_checkpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">removing_checkpoint</span><span class="p">)</span>
<span class="linenos">1086</span>                                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">removing_checkpoint</span><span class="p">)</span>
<span class="linenos">1087</span>
<span class="linenos">1088</span>                        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;checkpoint-</span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">1089</span>                        <span class="n">accelerator</span><span class="o">.</span><span class="n">save_state</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="linenos">1090</span>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved state to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">1091</span>
<span class="linenos">1092</span>            <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]}</span>
<span class="linenos">1093</span>            <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="o">**</span><span class="n">logs</span><span class="p">)</span>
<span class="linenos">1094</span>
<span class="linenos">1095</span>            <span class="k">if</span> <span class="n">global_step</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_train_steps</span><span class="p">:</span>
<span class="linenos">1096</span>                <span class="k">break</span>
<span class="linenos">1097</span>
<span class="linenos">1098</span>        <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos">1099</span>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">validation_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1100</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos">1101</span>                    <span class="c1"># Store the UNet parameters temporarily and load the EMA parameters to perform inference.</span>
<span class="linenos">1102</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">1103</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">1104</span>                <span class="n">log_validation</span><span class="p">(</span>
<span class="linenos">1105</span>                    <span class="n">vae</span><span class="p">,</span>
<span class="linenos">1106</span>                    <span class="n">text_encoder</span><span class="p">,</span>
<span class="linenos">1107</span>                    <span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos">1108</span>                    <span class="n">unet</span><span class="p">,</span>
<span class="linenos">1109</span>                    <span class="n">args</span><span class="p">,</span>
<span class="linenos">1110</span>                    <span class="n">accelerator</span><span class="p">,</span>
<span class="linenos">1111</span>                    <span class="n">weight_dtype</span><span class="p">,</span>
<span class="linenos">1112</span>                    <span class="n">global_step</span><span class="p">,</span>
<span class="linenos">1113</span>                <span class="p">)</span>
<span class="linenos">1114</span>                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos">1115</span>                    <span class="c1"># Switch back to the original UNet parameters.</span>
<span class="linenos">1116</span>                    <span class="n">ema_unet</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">1117</span>
<span class="linenos">1118</span>    <span class="c1"># Create the pipeline using the trained modules and save it.</span>
<span class="linenos">1119</span>    <span class="n">accelerator</span><span class="o">.</span><span class="n">wait_for_everyone</span><span class="p">()</span>
<span class="linenos">1120</span>    <span class="k">if</span> <span class="n">accelerator</span><span class="o">.</span><span class="n">is_main_process</span><span class="p">:</span>
<span class="linenos">1121</span>        <span class="n">unet</span> <span class="o">=</span> <span class="n">unwrap_model</span><span class="p">(</span><span class="n">unet</span><span class="p">)</span>
<span class="linenos">1122</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<span class="linenos">1123</span>            <span class="n">ema_unet</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="linenos">1124</span>
<span class="linenos">1125</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">StableDiffusionPipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos">1126</span>            <span class="n">args</span><span class="o">.</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span>
<span class="linenos">1127</span>            <span class="n">text_encoder</span><span class="o">=</span><span class="n">text_encoder</span><span class="p">,</span>
<span class="linenos">1128</span>            <span class="n">vae</span><span class="o">=</span><span class="n">vae</span><span class="p">,</span>
<span class="linenos">1129</span>            <span class="n">unet</span><span class="o">=</span><span class="n">unet</span><span class="p">,</span>
<span class="linenos">1130</span>            <span class="n">revision</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
<span class="linenos">1131</span>            <span class="n">variant</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">variant</span><span class="p">,</span>
<span class="linenos">1132</span>        <span class="p">)</span>
<span class="linenos">1133</span>        <span class="n">pipeline</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="linenos">1134</span>
<span class="linenos">1135</span>        <span class="c1"># Run a final round of inference.</span>
<span class="linenos">1136</span>        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1137</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1138</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running inference for collecting generated images...&quot;</span><span class="p">)</span>
<span class="linenos">1139</span>            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">1140</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">torch_dtype</span> <span class="o">=</span> <span class="n">weight_dtype</span>
<span class="linenos">1141</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">set_progress_bar_config</span><span class="p">(</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1142</span>
<span class="linenos">1143</span>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">:</span>
<span class="linenos">1144</span>                <span class="n">pipeline</span><span class="o">.</span><span class="n">enable_xformers_memory_efficient_attention</span><span class="p">()</span>
<span class="linenos">1145</span>
<span class="linenos">1146</span>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1147</span>                <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1148</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1149</span>                <span class="n">generator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos">1150</span>
<span class="linenos">1151</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">)):</span>
<span class="linenos">1152</span>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">):</span>
<span class="linenos">1153</span>                    <span class="n">image</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">validation_prompts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_inference_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1154</span>                <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="linenos">1155</span>
<span class="linenos">1156</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">:</span>
<span class="linenos">1157</span>            <span class="n">save_model_card</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">repo_folder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="linenos">1158</span>            <span class="n">upload_folder</span><span class="p">(</span>
<span class="linenos">1159</span>                <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
<span class="linenos">1160</span>                <span class="n">folder_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
<span class="linenos">1161</span>                <span class="n">commit_message</span><span class="o">=</span><span class="s2">&quot;End of training&quot;</span><span class="p">,</span>
<span class="linenos">1162</span>                <span class="n">ignore_patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;step_*&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch_*&quot;</span><span class="p">],</span>
<span class="linenos">1163</span>            <span class="p">)</span>
<span class="linenos">1164</span>
<span class="linenos">1165</span>    <span class="n">accelerator</span><span class="o">.</span><span class="n">end_training</span><span class="p">()</span>
<span class="linenos">1166</span>
<span class="linenos">1167</span>
<span class="linenos">1168</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">1169</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">export</span><span class="w"> </span><span class="nv">MODEL_NAME</span><span class="o">=</span><span class="s2">&quot;CompVis/stable-diffusion-v1-4&quot;</span>
<span class="linenos"> 2</span><span class="nb">export</span><span class="w"> </span><span class="nv">DATASET_NAME</span><span class="o">=</span><span class="s2">&quot;lambdalabs/naruto-blip-captions&quot;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>accelerate<span class="w"> </span>launch<span class="w"> </span>--mixed_precision<span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="w">  </span>train_text_to_image.py<span class="w"> </span><span class="se">\</span>
<span class="linenos"> 5</span>--pretrained_model_name_or_path<span class="o">=</span><span class="nv">$MODEL_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="linenos"> 6</span>--dataset_name<span class="o">=</span><span class="nv">$DATASET_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="linenos"> 7</span>--use_ema<span class="w"> </span><span class="se">\</span>
<span class="linenos"> 8</span>--resolution<span class="o">=</span><span class="m">512</span><span class="w"> </span>--center_crop<span class="w"> </span>--random_flip<span class="w"> </span><span class="se">\</span>
<span class="linenos"> 9</span>--train_batch_size<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">10</span>--gradient_accumulation_steps<span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">11</span>--gradient_checkpointing<span class="w"> </span><span class="se">\</span>
<span class="linenos">12</span>--max_train_steps<span class="o">=</span><span class="m">15000</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">13</span>--learning_rate<span class="o">=</span>1e-05<span class="w"> </span><span class="se">\</span>
<span class="linenos">14</span>--max_grad_norm<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">15</span>--lr_scheduler<span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="w"> </span>--lr_warmup_steps<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">16</span>--output_dir<span class="o">=</span><span class="s2">&quot;sd-pokemon-model&quot;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="install.html" class="btn btn-neutral float-left" title="安装指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="examples.html" class="btn btn-neutral float-right" title="功能样例" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, Ascend。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>